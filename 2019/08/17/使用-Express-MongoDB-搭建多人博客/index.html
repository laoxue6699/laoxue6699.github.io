<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    save_scroll: false,
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="转自 https://github.com/nswbmw Node.js安装 Node.js有三种方式安装 Node.js：一是通过安装包安装，二是通过源码编译安装，三是在 Linux 下可以通过 yum|apt-get 安装，在 Mac 下可以通过 Homebrew 安装。对于 Windows 和 Mac 用户，推荐使用安装包安装，Linux 用户推荐使用源码编译安装。">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Express + MongoDB 搭建多人博客">
<meta property="og:url" content="http://laoxue6699.github.io/2019/08/17/使用-Express-MongoDB-搭建多人博客/index.html">
<meta property="og:site_name" content="老学的开发笔记">
<meta property="og:description" content="转自 https://github.com/nswbmw Node.js安装 Node.js有三种方式安装 Node.js：一是通过安装包安装，二是通过源码编译安装，三是在 Linux 下可以通过 yum|apt-get 安装，在 Mac 下可以通过 Homebrew 安装。对于 Windows 和 Mac 用户，推荐使用安装包安装，Linux 用户推荐使用源码编译安装。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.1.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.1.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.1.3.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.1.4.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.1.5.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.2.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.2.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.2.3.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.2.4.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/1.2.5.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/2.2.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/2.6.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/3.1.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/3.1.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/3.3.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/3.4.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/3.4.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.2.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.2.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.3.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.4.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.5.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.6.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.7.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.8.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.9.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.10.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.11.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.12.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.5.13.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.7.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.8.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.8.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.8.3.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.14.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.14.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.14.3.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.15.1.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.15.2.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.15.3.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.15.4.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.15.5.png">
<meta property="og:image" content="http://laoxue6699.github.io/images/4.15.6.png">
<meta property="og:updated_time" content="2019-08-17T12:32:39.583Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 Express + MongoDB 搭建多人博客">
<meta name="twitter:description" content="转自 https://github.com/nswbmw Node.js安装 Node.js有三种方式安装 Node.js：一是通过安装包安装，二是通过源码编译安装，三是在 Linux 下可以通过 yum|apt-get 安装，在 Mac 下可以通过 Homebrew 安装。对于 Windows 和 Mac 用户，推荐使用安装包安装，Linux 用户推荐使用源码编译安装。">
<meta name="twitter:image" content="http://laoxue6699.github.io/images/1.1.1.png">
  <link rel="canonical" href="http://laoxue6699.github.io/2019/08/17/使用-Express-MongoDB-搭建多人博客/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>使用 Express + MongoDB 搭建多人博客 | 老学的开发笔记</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">老学的开发笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">专注前端 兼顾全栈</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>笔记列表</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>按时间归档</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>笔记分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>技术标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>自我介绍</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content page-post-detail">
            

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://laoxue6699.github.io/2019/08/17/使用-Express-MongoDB-搭建多人博客/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老学">
      <meta itemprop="description" content="好记性不如烂笔头">
      <meta itemprop="image" content="/images/laoxue.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老学的开发笔记">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">使用 Express + MongoDB 搭建多人博客

            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-08-17 18:49:40 / 修改时间：20:32:39" itemprop="dateCreated datePublished" datetime="2019-08-17T18:49:40+08:00">2019-08-17</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/转载/" itemprop="url" rel="index"><span itemprop="name">转载</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a href="https://github.com/nswbmw" target="_blank" rel="noopener">转自 https://github.com/nswbmw</a></p>
<h1 id="Node-js"><a href="#Node-js" class="headerlink" title="Node.js"></a>Node.js</h1><h2 id="安装-Node-js"><a href="#安装-Node-js" class="headerlink" title="安装 Node.js"></a>安装 Node.js</h2><p>有三种方式安装 Node.js：一是通过安装包安装，二是通过源码编译安装，三是在 Linux 下可以通过 yum|apt-get 安装，在 Mac 下可以通过 <a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a> 安装。对于 Windows 和 Mac 用户，推荐使用安装包安装，Linux 用户推荐使用源码编译安装。</p>
<a id="more"></a>

<h3 id="Windows-和-Mac-安装："><a href="#Windows-和-Mac-安装：" class="headerlink" title="Windows 和 Mac 安装："></a>Windows 和 Mac 安装：</h3><h4 id="第一步："><a href="#第一步：" class="headerlink" title="第一步："></a>第一步：</h4><p>打开 <a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js 官网</a>，可以看到以下两个下载选项：</p>
<p><img src="/images/1.1.1.png" alt></p>
<p>左边的是 LTS 版，用过 ubuntu 的同学可能比较熟悉，即长期支持版本，大多数人用这个就可以了。右边是最新版，支持最新的语言特性（比如对 ES6 的支持更全面），想尝试新特性的开发者可以安装这个版本。我们选择左边的 v6.9.1 LTS 点击下载。</p>
<blockquote>
<p>小提示：从 <a href="http://node.green" target="_blank" rel="noopener">http://node.green</a> 上可以看到 Node.js 各个版本对 ES6 的支持情况。</p>
</blockquote>
<h4 id="第二步："><a href="#第二步：" class="headerlink" title="第二步："></a>第二步：</h4><p>安装 Node.js，这个没什么好说的，一直点击 <code>继续</code> 即可。</p>
<p><img src="/images/1.1.2.png" alt></p>
<h4 id="第三步："><a href="#第三步：" class="headerlink" title="第三步："></a>第三步：</h4><p>提示安装成功后，打开终端输入以下命令，可以看到 node 和 npm 都已经安装好了：</p>
<p><img src="/images/1.1.3.png" alt></p>
<h3 id="Linux-安装："><a href="#Linux-安装：" class="headerlink" title="Linux 安装："></a>Linux 安装：</h3><p>Linux 用户可通过源码编译安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://nodejs.org/dist/v6.9.1/node-v6.9.1.tar.gz</span><br><span class="line">tar -xzvf node-v6.9.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> node-v6.9.1</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意: 如果编译过程报错，可能是缺少某些依赖包。因为报错内容不尽相同，请读者自行求助搜索引擎或 <a href="http://stackoverflow.com/" target="_blank" rel="noopener">stackoverflow</a>。</p>
</blockquote>
<h2 id="n-和-nvm"><a href="#n-和-nvm" class="headerlink" title="n 和 nvm"></a>n 和 nvm</h2><p>通常我们使用稳定的 LTS 版本的 Node.js 即可，但有的情况下我们又想尝试一下新的特性，我们总不能来回安装不同版本的 Node.js 吧，这个时候我们就需要 <a href="https://github.com/tj/n" target="_blank" rel="noopener">n</a> 或者 <a href="https://github.com/creationix/nvm" target="_blank" rel="noopener">nvm</a> 了。n 和 nvm 是两个常用的 Node.js 版本管理工具，关于 n 和 nvm 的使用以及区别，<a href="http://taobaofed.org/blog/2015/11/17/nvm-or-n/" target="_blank" rel="noopener">这篇文章</a> 讲得特别详细，这里不再赘述。</p>
<h2 id="nrm"><a href="#nrm" class="headerlink" title="nrm"></a>nrm</h2><p><a href="https://github.com/Pana/nrm" target="_blank" rel="noopener">nrm</a> 是一个管理 npm 源的工具。用过 ruby 和 gem 的同学会比较熟悉，通常我们会把 gem 源切到国内的淘宝镜像，这样在安装和更新一些包的时候比较快。nrm 同理，用来切换官方 npm 源和国内的 npm 源（如: <a href="http://cnpmjs.org/" target="_blank" rel="noopener">cnpm</a>），当然也可以用来切换官方 npm 源和公司私有 npm 源。</p>
<p>全局安装 nrm:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i nrm -g</span><br></pre></td></tr></table></figure>

<p>查看当前 nrm 内置的几个 npm 源的地址：</p>
<p><img src="/images/1.1.4.png" alt></p>
<p>切换到 cnpm：</p>
<p><img src="/images/1.1.5.png" alt></p>
<h2 id="安装与启动-MongoDB"><a href="#安装与启动-MongoDB" class="headerlink" title="安装与启动 MongoDB"></a>安装与启动 MongoDB</h2><ul>
<li>Windows 用户向导：<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-windows/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-windows/</a></li>
<li>Linux 用户向导：<a href="https://docs.mongodb.com/manual/administration/install-on-linux/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/administration/install-on-linux/</a></li>
<li>Mac 用户向导：<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/</a></li>
</ul>
<h3 id="Robomongo-和-Mongochef"><a href="#Robomongo-和-Mongochef" class="headerlink" title="Robomongo 和 Mongochef"></a>Robomongo 和 Mongochef</h3><h4 id="Robomongo"><a href="#Robomongo" class="headerlink" title="Robomongo"></a>Robomongo</h4><p><a href="https://robomongo.org/" target="_blank" rel="noopener">Robomongo</a> 是一个基于 Shell 的跨平台开源 MongoDB 可视化管理工具，支持 Windows、Linux 和 Mac，嵌入了 JavaScript 引擎和 MongoDB mongo，只要你会使用 mongo shell，你就会使用 Robomongo，它还提供了语法高亮、自动补全、差别视图等。</p>
<p><a href="https://robomongo.org/download" target="_blank" rel="noopener">Robomongo 下载地址</a></p>
<p>下载并安装成功后点击左上角的 <code>Create</code> 创建一个连接，给该连接起个名字如: <code>localhost</code>，使用默认地址（localhost）和端口（27017）即可，点击 <code>Save</code> 保存。</p>
<p><img src="/images/1.2.1.png" alt></p>
<p>双击 <code>localhost</code> 连接到 MongoDB 并进入交互界面，尝试插入一条数据并查询出来，如下所示:</p>
<p><img src="/images/1.2.2.png" alt></p>
<h4 id="MongoChef"><a href="#MongoChef" class="headerlink" title="MongoChef"></a>MongoChef</h4><p><a href="http://3t.io/mongochef/" target="_blank" rel="noopener">MongoChef</a> 是另一款强大的 MongoDB 可视化管理工具，支持 Windows、Linux 和 Mac。</p>
<p><a href="http://3t.io/mongochef/#mongochef-download-compare" target="_blank" rel="noopener">MongoChef 下载地址</a>，我们选择左侧的非商业用途的免费版下载。</p>
<p><img src="/images/1.2.3.png" alt></p>
<p>安装成功后跟 Robomongo 一样，也需要创建一个新的连接的配置，成功后双击进入到 MongoChef 主页面，如下所示:</p>
<p><img src="/images/1.2.4.png" alt></p>
<p>还可以使用 shell 模式:</p>
<p><img src="/images/1.2.5.png" alt></p>
<blockquote>
<p>小提示: MongoChef 相较于 Robomongo 更强大一些，但 Robomongo 比较轻量也能满足大部分的常规需求，所以哪一个适合自己还需读者自行尝试。</p>
</blockquote>
<h2 id="require"><a href="#require" class="headerlink" title="require"></a>require</h2><p>require 用来加载一个文件的代码，关于 require 的机制这里不展开讲解，请仔细阅读 <a href="https://nodejs.org/api/modules.html" target="_blank" rel="noopener">官方文档</a>。</p>
<p>简单概括以下几点:</p>
<ul>
<li>require 可加载 .js、.json 和 .node 后缀的文件</li>
<li>require 的过程是同步的，所以这样是错误的:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  module.exports = &#123; a: <span class="string">'hello'</span> &#125;</span><br><span class="line">&#125;, 0)</span><br></pre></td></tr></table></figure>

<p>require 这个文件得到的是空对象 <code>{}</code></p>
<ul>
<li>require 目录的机制是:<ul>
<li>如果目录下有 package.json 并指定了 main 字段，则用之</li>
<li>如果不存在 package.json，则依次尝试加载目录下的 index.js 和 index.node</li>
</ul>
</li>
<li>require 过的文件会加载到缓存，所以多次 require 同一个文件（模块）不会重复加载</li>
<li>判断是否是程序的入口文件有两种方式:<ul>
<li>require.main === module（推荐）</li>
<li>module.parent === null</li>
</ul>
</li>
</ul>
<h2 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h2><p>循环引用（或循环依赖）简单点来说就是 a 文件 require 了 b 文件，然后 b 文件又反过来 require 了 a 文件。我们用 a-&gt;b 代表 b require 了 a。</p>
<p>简单的情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a-&gt;b</span><br><span class="line">b-&gt;a</span><br></pre></td></tr></table></figure>

<p>复杂点的情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a-&gt;b</span><br><span class="line">b-&gt;c</span><br><span class="line">c-&gt;a</span><br></pre></td></tr></table></figure>

<p>循环引用并不会报错，导致的结果是 require 的结果是空对象 <code>{}</code>，原因是 b require 了 a，a 又去 require 了 b，此时 b 还没初始化好，所以只能拿到初始值 <code>{}</code>。当产生循环引用时一般有两种方法解决：</p>
<ol>
<li>通过分离共用的代码到另一个文件解决，如上面简单的情况，可拆出共用的代码到 c 中，如下:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c-&gt;a</span><br><span class="line">c-&gt;b</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>不在最外层 require，在用到的地方 require，通常在函数的内部</li>
</ol>
<p>总的来说，循环依赖的陷阱并不大容易出现，但一旦出现了，对于新手来说还真不好定位。它的存在给我们提了个醒，要时刻注意你项目的依赖关系不要过于复杂，哪天你发现一个你明明已经 exports 了的方法报 <code>undefined is not a function</code>，我们就该提醒一下自己：哦，也许是它来了。</p>
<p>官方示例: <a href="https://nodejs.org/api/modules.html#modules_cycles" target="_blank" rel="noopener">https://nodejs.org/api/modules.html#modules_cycles</a></p>
<p>require 用来加载代码，而 exports 和 module.exports 则用来导出代码。</p>
<p>很多新手可能会迷惑于 exports 和 module.exports 的区别，为了更好的理解 exports 和 module.exports 的关系，我们先来巩固下 js 的基础。示例：</p>
<p><strong>test.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123; <span class="attr">name</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> b = a;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="built_in">console</span>.log(b);</span><br><span class="line"></span><br><span class="line">b.name = <span class="number">2</span>;</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="built_in">console</span>.log(b);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = &#123; <span class="attr">name</span>: <span class="number">3</span> &#125;;</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="built_in">console</span>.log(b);</span><br></pre></td></tr></table></figure>

<p>运行 test.js 结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; name: 1 &#125;</span><br><span class="line">&#123; name: 1 &#125;</span><br><span class="line">&#123; name: 2 &#125;</span><br><span class="line">&#123; name: 2 &#125;</span><br><span class="line">&#123; name: 2 &#125;</span><br><span class="line">&#123; name: 3 &#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释</strong>：a 是一个对象，b 是对 a 的引用，即 a 和 b 指向同一块内存，所以前两个输出一样。当对 b 作修改时，即 a 和 b 指向同一块内存地址的内容发生了改变，所以 a 也会体现出来，所以第三四个输出一样。当 b 被覆盖时，b 指向了一块新的内存，a 还是指向原来的内存，所以最后两个输出不一样。</p>
<p>明白了上述例子后，我们只需知道三点就知道 exports 和 module.exports 的区别了：</p>
<ol>
<li>module.exports 初始值为一个空对象 {}</li>
<li>exports 是指向的 module.exports 的引用</li>
<li>require() 返回的是 module.exports 而不是 exports</li>
</ol>
<p>Node.js 官方文档的截图证实了我们的观点:</p>
<p><img src="/images/2.2.1.png" alt></p>
<h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><p>exports = module.exports = {…}</p>
<p>我们经常看到这样的写法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exports = <span class="built_in">module</span>.exports = &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码等价于:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;...&#125;</span><br><span class="line">exports = <span class="built_in">module</span>.exports</span><br></pre></td></tr></table></figure>

<p>原理很简单：module.exports 指向新的对象时，exports 断开了与 module.exports 的引用，那么通过 exports = module.exports 让 exports 重新指向 module.exports。</p>
<blockquote>
<p>小提示：ES6 的 import 和 export 不在本文的讲解范围，有兴趣的读者可以去学习阮一峰老师的<a href="http://es6.ruanyifeng.com/" target="_blank" rel="noopener">《ECMAScript6 入门》</a>。</p>
</blockquote>
<h1 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h1><p>网上已经有许多关于 Promise 的资料了，这里不在赘述。以下 4 个链接供读者学习：</p>
<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise</a> （基础）</li>
<li><a href="http://liubin.org/promises-book/" target="_blank" rel="noopener">http://liubin.org/promises-book/</a> （开源 Promise 迷你书）</li>
<li><a href="http://fex.baidu.com/blog/2015/07/we-have-a-problem-with-promises/" target="_blank" rel="noopener">http://fex.baidu.com/blog/2015/07/we-have-a-problem-with-promises/</a> （进阶）</li>
<li><a href="https://promisesaplus.com/" target="_blank" rel="noopener">https://promisesaplus.com/</a> （官方定义规范）</li>
</ol>
<p>Promise 用于异步流程控制，生成器与 yield 也能实现流程控制（基于 co），但不在本教程讲解范围内，读者可参考我的另一部教程 <a href="https://github.com/nswbmw/N-club" target="_blank" rel="noopener">N-club</a>。async/await 结合 Promise 也可以实现流程控制，有兴趣请查阅 <a href="http://es6.ruanyifeng.com/#docs/async#async函数" target="_blank" rel="noopener">《ECMAScript6 入门》</a>。</p>
<h2 id="深入-Promise"><a href="#深入-Promise" class="headerlink" title="深入 Promise"></a>深入 Promise</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/30797777" target="_blank" rel="noopener">Promise 必知必会（十道题）</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/25178630" target="_blank" rel="noopener">深入 Promise(一)——Promise 实现详解</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/25198178" target="_blank" rel="noopener">深入 Promise(二)——进击的 Promise</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/25199781" target="_blank" rel="noopener">深入 Promise(三)——命名 Promise</a></li>
</ul>
<p>环境变量不属于 Node.js 的知识范畴，只不过我们在开发 Node.js 应用时经常与环境变量打交道，所以这里简单介绍下。</p>
<p>环境变量（environment variables）一般是指在操作系统中用来指定操作系统运行环境的一些参数。在 Mac 和 Linux 的终端直接输入 env，会列出当前的环境变量，如：USER=xxx。简单来讲，环境变量就是传递参数给运行程序的。</p>
<p>在 Node.js 中，我们经常这么用:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV=<span class="built_in">test</span> node app</span><br></pre></td></tr></table></figure>

<p>通过以上命令启动程序，指定当前环境变量 <code>NODE_ENV</code> 的值为 test，那么在 app.js 中可通过 <code>process.env</code> 来获取环境变量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(process.env.NODE_ENV) //test</span><br></pre></td></tr></table></figure>

<p>另一个常见的例子是使用 <a href="https://www.npmjs.com/package/debug" target="_blank" rel="noopener">debug</a> 模块时:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBUG=* node app</span><br></pre></td></tr></table></figure>

<p>Windows 用户需要首先设置环境变量，然后再执行程序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> DEBUG=*</span><br><span class="line"><span class="built_in">set</span> NODE_ENV=<span class="built_in">test</span></span><br><span class="line">node app</span><br></pre></td></tr></table></figure>

<p>或者使用 <a href="https://www.npmjs.com/package/cross-env" target="_blank" rel="noopener">cross-env</a>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i cross-env -g</span><br></pre></td></tr></table></figure>

<p>使用方式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cross-env NODE_ENV=<span class="built_in">test</span> node app</span><br></pre></td></tr></table></figure>

<p>package.json 对于 Node.js 应用来说是一个不可或缺的文件，它存储了该 Node.js 应用的名字、版本、描述、作者、入口文件、脚本、版权等等信息。npm 官网有 package.json 每个字段的详细介绍：<a href="https://docs.npmjs.com/files/package.json" target="_blank" rel="noopener">https://docs.npmjs.com/files/package.json</a>。</p>
<h2 id="semver"><a href="#semver" class="headerlink" title="semver"></a>semver</h2><p>语义化版本（semver）即 dependencies、devDependencies 和 peerDependencies 里的如：<code>&quot;co&quot;: &quot;^4.6.0&quot;</code>。</p>
<p>semver 格式：<code>主版本号.次版本号.修订号</code>。版本号递增规则如下：</p>
<ul>
<li><code>主版本号</code>：做了不兼容的 API 修改</li>
<li><code>次版本号</code>：做了向下兼容的功能性新增</li>
<li><code>修订号</code>：做了向下兼容的 bug 修正</li>
</ul>
<p>更多阅读：</p>
<ol>
<li><a href="http://semver.org/lang/zh-CN/" target="_blank" rel="noopener">http://semver.org/lang/zh-CN/</a></li>
<li><a href="http://taobaofed.org/blog/2016/08/04/instructions-of-semver/" target="_blank" rel="noopener">http://taobaofed.org/blog/2016/08/04/instructions-of-semver/</a></li>
</ol>
<h1 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h1><p>作为 Node.js 的开发者，我们在发布 npm 模块的时候一定要遵守语义化版本的命名规则，即：有 breaking change 发大版本，有新增的功能发小版本，有小的 bug 修复或优化则发修订版本。</p>
<h2 id="npm-init"><a href="#npm-init" class="headerlink" title="npm init"></a>npm init</h2><p>使用 <code>npm init</code> 初始化一个空项目是一个好的习惯，即使你对 package.json 及其他属性非常熟悉，<code>npm init</code> 也是你开始写新的 Node.js 应用或模块的一个快捷的办法。<code>npm init</code> 有智能的默认选项，比如从根目录名称推断模块名称，通过 <code>~/.npmrc</code> 读取你的信息，用你的 Git 设置来确定 repository 等等。</p>
<h2 id="npm-install"><a href="#npm-install" class="headerlink" title="npm install"></a>npm install</h2><p><code>npm install</code> 是我们最常用的 npm 命令之一，因此我们需要好好了解下这个命令。终端输入 <code>npm install -h</code> 查看使用方式:</p>
<p><img src="/images/2.6.1.png" alt></p>
<p>可以看出：我们通过 <code>npm install</code> 可以安装 npm 上发布的某个版本、某个 tag、某个版本区间的模块，甚至可以安装本地目录、压缩包和 git/github 的库作为依赖。</p>
<blockquote>
<p>小提示: <code>npm i</code> 是 <code>npm install</code> 的简写，建议使用 <code>npm i</code>。</p>
</blockquote>
<p>直接使用 <code>npm i</code> 安装的模块是不会写入 package.json 的 dependencies (或 devDependencies)，需要额外加个参数:</p>
<ol>
<li><code>npm i express --save</code>/<code>npm i express -S</code> (安装 express，同时将 <code>&quot;express&quot;: &quot;^4.14.0&quot;</code> 写入 dependencies )</li>
<li><code>npm i express --save-dev</code>/<code>npm i express -D</code> (安装 express，同时将 <code>&quot;express&quot;: &quot;^4.14.0&quot;</code> 写入 devDependencies )</li>
<li><code>npm i express --save --save-exact</code> (安装 express，同时将 <code>&quot;express&quot;: &quot;4.14.0&quot;</code> 写入 dependencies )</li>
</ol>
<p>第三种方式将固定版本号写入 dependencies，建议线上的 Node.js 应用都采取这种锁定版本号的方式，因为你不可能保证第三方模块下个小版本是没有验证 bug 的，即使是很流行的模块。拿 Mongoose 来说，Mongoose 4.1.4 引入了一个 bug 导致调用一个文档 entry 的 remove 会删除整个集合的文档，见：<a href="https://github.com/Automattic/mongoose/blob/master/History.md#415--2015-09-01" target="_blank" rel="noopener">https://github.com/Automattic/mongoose/blob/master/History.md#415–2015-09-01</a>。</p>
<blockquote>
<p>后面会介绍更安全的 <code>npm shrinkwrap</code> 的用法。</p>
</blockquote>
<p>运行以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> save-exact <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>这样每次 <code>npm i xxx --save</code> 的时候会锁定依赖的版本号，相当于加了 <code>--save-exact</code> 参数。</p>
<blockquote>
<p>小提示：<code>npm config set</code> 命令将配置写到了 ~/.npmrc 文件，运行 <code>npm config list</code> 查看。</p>
</blockquote>
<h2 id="npm-scripts"><a href="#npm-scripts" class="headerlink" title="npm scripts"></a>npm scripts</h2><p>npm 提供了灵活而强大的 scripts 功能，见 <a href="https://docs.npmjs.com/misc/scripts" target="_blank" rel="noopener">官方文档</a>。</p>
<p>npm 的 scripts 有一些内置的缩写命令，如常用的：</p>
<ul>
<li><code>npm start</code> 等价于 <code>npm run start</code></li>
<li><code>npm test</code> 等价于 <code>npm run test</code></li>
</ul>
<h2 id="npm-shrinkwrap"><a href="#npm-shrinkwrap" class="headerlink" title="npm shrinkwrap"></a>npm shrinkwrap</h2><p>前面说过要锁定依赖的版本，但这并不能完全防止意外情况的发生，因为锁定的只是最外一层的依赖，而里层依赖的模块的 package.json 有可能写的是 <code>&quot;mongoose&quot;: &quot;*&quot;</code>。为了彻底锁定依赖的版本，让你的应用在任何机器上安装的都是同样版本的模块（不管嵌套多少层），通过运行 <code>npm shrinkwrap</code>，会在当前目录下产生一个 <code>npm-shrinkwrap.json</code>，里面包含了通过 node_modules 计算出的模块的依赖树及版本。上面的截图也显示：只要目录下有 npm-shrinkwrap.json 则运行 <code>npm install</code> 的时候会优先使用 npm-shrinkwrap.json 进行安装，没有则使用 package.json 进行安装。</p>
<p>更多阅读：</p>
<ol>
<li><a href="https://docs.npmjs.com/cli/shrinkwrap" target="_blank" rel="noopener">https://docs.npmjs.com/cli/shrinkwrap</a></li>
<li><a href="http://tech.meituan.com/npm-shrinkwrap.html" target="_blank" rel="noopener">http://tech.meituan.com/npm-shrinkwrap.html</a></li>
</ol>
<blockquote>
<p>注意: 如果 node_modules 下存在某个模块（如直接通过 <code>npm install xxx</code> 安装的）而 package.json 中没有，运行 <code>npm shrinkwrap</code> 则会报错。另外，<code>npm shrinkwrap</code> 只会生成 dependencies 的依赖，不会生成 devDependencies 的。</p>
</blockquote>
<h1 id="express"><a href="#express" class="headerlink" title="express"></a>express</h1><p>首先，我们新建一个目录 myblog，在该目录下运行 <code>npm init</code> 生成一个 package.json，如下所示：</p>
<p><img src="/images/3.1.1.png" alt></p>
<blockquote>
<p>注意：括号里的是默认值，如果使用默认值则直接回车即可，否则输入自定义内容后回车。</p>
</blockquote>
<p>然后安装 express 并写入 package.json：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express@4.14.0 --save</span><br></pre></td></tr></table></figure>

<p>新建 index.js，添加如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"hello, express"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>以上代码的意思是：生成一个 express 实例 app，挂载了一个根路由控制器，然后监听 3000 端口并启动程序。运行 <code>node index</code>，打开浏览器访问 <code>localhost:3000</code> 时，页面应显示 hello, express。</p>
<p>这是最简单的一个使用 express 的例子，后面会介绍路由及模板的使用。</p>
<h2 id="supervisor"><a href="#supervisor" class="headerlink" title="supervisor"></a>supervisor</h2><p>在开发过程中，每次修改代码保存后，我们都需要手动重启程序，才能查看改动的效果。使用 <a href="https://www.npmjs.com/package/supervisor" target="_blank" rel="noopener">supervisor</a> 可以解决这个繁琐的问题，全局安装 supervisor：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g supervisor</span><br></pre></td></tr></table></figure>

<p>运行 <code>supervisor index</code> 启动程序，如下所示：</p>
<p><img src="/images/3.1.2.png" alt></p>
<p>supervisor 会监听当前目录下 node 和 js 后缀的文件，当这些文件发生改动时，supervisor 会自动重启程序。</p>
<p>前面我们只是挂载了根路径的路由控制器，现在修改 index.js 如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"hello, express"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/users/:name"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"hello, "</span> + req.params.name);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>以上代码的意思是：当访问根路径时，依然返回 hello, express，当访问如 <code>localhost:3000/users/nswbmw</code> 路径时，返回 hello, nswbmw。路径中 <code>:name</code> 起了占位符的作用，这个占位符的名字是 name，可以通过 <code>req.params.name</code> 取到实际的值。</p>
<blockquote>
<p>小提示：express 使用了 <a href="https://www.npmjs.com/package/path-to-regexp" target="_blank" rel="noopener">path-to-regexp</a> 模块实现的路由匹配。</p>
</blockquote>
<p>不难看出：req 包含了请求来的相关信息，res 则用来返回该请求的响应，更多请查阅 <a href="http://expressjs.com/en/4x/api.html" target="_blank" rel="noopener">express 官方文档</a>。下面介绍几个常用的 req 的属性：</p>
<ul>
<li><code>req.query</code>: 解析后的 url 中的 querystring，如 <code>?name=haha</code>，req.query 的值为 <code>{name: &#39;haha&#39;}</code></li>
<li><code>req.params</code>: 解析 url 中的占位符，如 <code>/:name</code>，访问 /haha，req.params 的值为 <code>{name: &#39;haha&#39;}</code></li>
<li><code>req.body</code>: 解析后请求体，需使用相关的模块，如 <a href="https://www.npmjs.com/package/body-parser" target="_blank" rel="noopener">body-parser</a>，请求体为 <code>{&quot;name&quot;: &quot;haha&quot;}</code>，则 req.body 为 <code>{name: &#39;haha&#39;}</code></li>
</ul>
<h2 id="express-Router"><a href="#express-Router" class="headerlink" title="express.Router"></a>express.Router</h2><p>上面只是很简单的路由使用的例子（将所有路由控制函数都放到了 index.js），但在实际开发中通常有几十甚至上百的路由，都写在 index.js 既臃肿又不好维护，这时可以使用 express.Router 实现更优雅的路由解决方案。在 myblog 目录下创建空文件夹 routes，在 routes 目录下创建 index.js 和 users.js。最后代码如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="built_in">require</span>(<span class="string">"./routes/index"</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">"./routes/users"</span>);</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/"</span>, indexRouter);</span><br><span class="line">app.use(<span class="string">"/users"</span>, userRouter);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p><strong>routes/index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"hello, express"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p><strong>routes/users.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:name"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"hello, "</span> + req.params.name);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p>以上代码的意思是：我们将 <code>/</code> 和 <code>/users/:name</code> 的路由分别放到了 routes/index.js 和 routes/users.js 中，每个路由文件通过生成一个 express.Router 实例 router 并导出，通过 <code>app.use</code> 挂载到不同的路径。这两种代码实现了相同的功能，但在实际开发中推荐使用 express.Router 将不同的路由分离到不同的路由文件中。</p>
<p>更多 express.Router 的用法见 <a href="http://expressjs.com/en/4x/api.html#router" target="_blank" rel="noopener">express 官方文档</a>。</p>
<p>模板引擎（Template Engine）是一个将页面模板和数据结合起来生成 html 的工具。上例中，我们只是返回纯文本给浏览器，现在我们修改代码返回一个 html 页面给浏览器。</p>
<h2 id="ejs"><a href="#ejs" class="headerlink" title="ejs"></a>ejs</h2><p>模板引擎有很多，<a href="https://www.npmjs.com/package/ejs" target="_blank" rel="noopener">ejs</a> 是其中一种，因为它使用起来十分简单，而且与 express 集成良好，所以我们使用 ejs。安装 ejs：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i ejs --save</span><br></pre></td></tr></table></figure>

<p>修改 index.js 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="built_in">require</span>(<span class="string">"./routes/index"</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">"./routes/users"</span>);</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">"views"</span>, path.join(__dirname, <span class="string">"views"</span>)); <span class="comment">// 设置存放模板文件的目录</span></span><br><span class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"ejs"</span>); <span class="comment">// 设置模板引擎为 ejs</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/"</span>, indexRouter);</span><br><span class="line">app.use(<span class="string">"/users"</span>, userRouter);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>通过 <code>app.set</code> 设置模板引擎为 ejs 和存放模板的目录。在 myblog 下新建 views 文件夹，在 views 下新建 users.ejs，添加如下代码：</p>
<p><strong>views/users.ejs</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line">      body &#123;</span><br><span class="line">        padding: 50px;</span><br><span class="line">        font: 14px "Lucida Grande", Helvetica, Arial, sans-serif;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">name.toUpperCase</span>() %&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>hello, <span class="tag">&lt;<span class="name">%=</span> <span class="attr">name</span> %&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改 routes/users.js 如下：</p>
<p><strong>routes/users.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:name"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">"users"</span>, &#123;</span><br><span class="line">    name: req.params.name</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p>通过调用 <code>res.render</code> 函数渲染 ejs 模板，res.render 第一个参数是模板的名字，这里是 users 则会匹配 views/users.ejs，第二个参数是传给模板的数据，这里传入 name，则在 ejs 模板中可使用 name。<code>res.render</code> 的作用就是将模板和数据结合生成 html，同时设置响应头中的 <code>Content-Type: text/html</code>，告诉浏览器我返回的是 html，不是纯文本，要按 html 展示。现在我们访问 <code>localhost:3000/users/haha</code>，如下图所示：</p>
<p><img src="/images/3.3.1.png" alt></p>
<p>上面代码可以看到，我们在模板 <code>&lt;%= name.toUpperCase() %&gt;</code> 中使用了 JavaScript 的语法 <code>.toUpperCase()</code> 将名字转化为大写，那这个 <code>&lt;%= xxx %&gt;</code> 是什么东西呢？ejs 有 3 种常用标签：</p>
<ol>
<li><code>&lt;% code %&gt;</code>：运行 JavaScript 代码，不输出</li>
<li><code>&lt;%= code %&gt;</code>：显示转义后的 HTML 内容</li>
<li><code>&lt;%- code %&gt;</code>：显示原始 HTML 内容</li>
</ol>
<blockquote>
<p>注意：<code>&lt;%= code %&gt;</code> 和 <code>&lt;%- code %&gt;</code> 都可以是 JavaScript 表达式生成的字符串，当变量 code 为普通字符串时，两者没有区别。当 code 比如为 <code>&lt;h1&gt;hello&lt;/h1&gt;</code> 这种字符串时，<code>&lt;%= code %&gt;</code> 会原样输出 <code>&lt;h1&gt;hello&lt;/h1&gt;</code>，而 <code>&lt;%- code %&gt;</code> 则会显示 H1 大的 hello 字符串。</p>
</blockquote>
<p>下面的例子解释了 <code>&lt;% code %&gt;</code> 的用法：</p>
<p><strong>Data</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supplies: [&apos;mop&apos;, &apos;broom&apos;, &apos;duster&apos;]</span><br></pre></td></tr></table></figure>

<p><strong>Template</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">&lt;% for(var i=0; i&lt;supplies.length; i++) &#123;%&gt;</span><br><span class="line">   &lt;li&gt;&lt;%= supplies[i] %&gt;&lt;/li&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Result</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>mop<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>broom<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>duster<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更多 ejs 的标签请看 <a href="https://www.npmjs.com/package/ejs#tags" target="_blank" rel="noopener">官方文档</a>。</p>
<h2 id="includes"><a href="#includes" class="headerlink" title="includes"></a>includes</h2><p>我们使用模板引擎通常不是一个页面对应一个模板，这样就失去了模板的优势，而是把模板拆成可复用的模板片段组合使用，如在 views 下新建 header.ejs 和 footer.ejs，并修改 users.ejs：</p>
<p><strong>views/header.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">      body &#123;padding: 50px;font: 14px &quot;Lucida Grande&quot;, Helvetica, Arial, sans-serif;&#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br></pre></td></tr></table></figure>

<p><strong>views/footer.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><strong>views/users.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line">  &lt;h1&gt;&lt;%= name.toUpperCase() %&gt;&lt;/h1&gt;</span><br><span class="line">  &lt;p&gt;hello, &lt;%= name %&gt;&lt;/p&gt;</span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>我们将原来的 users.ejs 拆成出了 header.ejs 和 footer.ejs，并在 users.ejs 通过 ejs 内置的 include 方法引入，从而实现了跟以前一个模板文件相同的功能。</p>
<blockquote>
<p>小提示：拆分模板组件通常有两个好处：</p>
<ol>
<li>模板可复用，减少重复代码</li>
<li>主模板结构清晰</li>
</ol>
</blockquote>
<blockquote>
<p>注意：要用 <code>&lt;%- include(&#39;header&#39;) %&gt;</code> 而不是 <code>&lt;%= include(&#39;header&#39;) %&gt;</code><br>前面我们讲解了 express 中路由和模板引擎 ejs 的用法，但 express 的精髓并不在此，在于中间件的设计理念。</p>
</blockquote>
<h2 id="中间件与-next"><a href="#中间件与-next" class="headerlink" title="中间件与 next"></a>中间件与 next</h2><p>express 中的中间件（middleware）就是用来处理请求的，当一个中间件处理完，可以通过调用 <code>next()</code> 传递给下一个中间件，如果没有调用 <code>next()</code>，则请求不会往下传递，如内置的 <code>res.render</code> 其实就是渲染完 html 直接返回给客户端，没有调用 <code>next()</code>，从而没有传递给下一个中间件。看个小例子，修改 index.js 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"1"</span>);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"2"</span>);</span><br><span class="line">  res.status(<span class="number">200</span>).end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>此时访问 <code>localhost:3000</code>，终端会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<p>通过 <code>app.use</code> 加载中间件，在中间件中通过 next 将请求传递到下一个中间件，next 可接受一个参数接收错误信息，如果使用了 <code>next(error)</code>，则会返回错误而不会传递到下一个中间件，修改 index.js 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"1"</span>);</span><br><span class="line">  next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"haha"</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"2"</span>);</span><br><span class="line">  res.status(<span class="number">200</span>).end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>此时访问 <code>localhost:3000</code>，终端会输出错误信息：</p>
<p><img src="/images/3.4.1.png" alt></p>
<p>浏览器会显示：</p>
<p><img src="/images/3.4.2.png" alt></p>
<blockquote>
<p>小提示：<code>app.use</code> 有非常灵活的使用方式，详情见 <a href="http://expressjs.com/en/4x/api.html#app.use" target="_blank" rel="noopener">官方文档</a>。</p>
</blockquote>
<p>express 有成百上千的第三方中间件，在开发过程中我们首先应该去 npm 上寻找是否有类似实现的中间件，尽量避免造轮子，节省开发时间。下面给出几个常用的搜索 npm 模块的网站：</p>
<ol>
<li><a href="http://npmjs.com" target="_blank" rel="noopener">http://npmjs.com</a>(npm 官网)</li>
<li><a href="http://node-modules.com" target="_blank" rel="noopener">http://node-modules.com</a></li>
<li><a href="https://npms.io" target="_blank" rel="noopener">https://npms.io</a></li>
<li><a href="https://nodejsmodules.org" target="_blank" rel="noopener">https://nodejsmodules.org</a></li>
</ol>
<blockquote>
<p>小提示：express@4 之前的版本基于 connect 这个模块实现的中间件的架构，express@4 及以上的版本则移除了对 connect 的依赖自己实现了，理论上基于 connect 的中间件（通常以 <code>connect-</code> 开头，如 <code>connect-mongo</code>）仍可结合 express 使用。</p>
</blockquote>
<blockquote>
<p>注意：中间件的加载顺序很重要！比如：通常把日志中间件放到比较靠前的位置，后面将会介绍的 <code>connect-flash</code> 中间件是基于 session 的，所以需要在 <code>express-session</code> 后加载。</p>
</blockquote>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>上面的例子中，应用程序为我们自动返回了错误栈信息（express 内置了一个默认的错误处理器），假如我们想手动控制返回的错误内容，则需要加载一个自定义错误处理的中间件，修改 index.js 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"1"</span>);</span><br><span class="line">  next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"haha"</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"2"</span>);</span><br><span class="line">  res.status(<span class="number">200</span>).end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//错误处理</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">"Something broke!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>此时访问 <code>localhost:3000</code>，浏览器会显示 <code>Something broke!</code>。</p>
<blockquote>
<p>小提示：关于 express 的错误处理，详情见 <a href="http://expressjs.com/en/guide/error-handling.html" target="_blank" rel="noopener">官方文档</a>。<br>从本章开始，正式学习如何使用 Express + MongoDB 搭建一个博客。</p>
</blockquote>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>我们停止 supervisor 并删除 myblog 目录从头来过。重新创建 myblog，运行 <code>npm init</code>，如下：</p>
<p><img src="/images/4.2.1.png" alt></p>
<p>在 myblog 目录下创建以下目录及空文件（package.json 除外）：</p>
<p><img src="/images/4.2.2.png" alt></p>
<p>对应文件及文件夹的用处：</p>
<ol>
<li><code>models</code>: 存放操作数据库的文件</li>
<li><code>public</code>: 存放静态文件，如样式、图片等</li>
<li><code>routes</code>: 存放路由文件</li>
<li><code>views</code>: 存放模板文件</li>
<li><code>index.js</code>: 程序主文件</li>
<li><code>package.json</code>: 存储项目名、描述、作者、依赖等等信息</li>
</ol>
<blockquote>
<p>小提示：不知读者发现了没有，我们遵循了 MVC（模型(model)－视图(view)－控制器(controller/route)） 的开发模式。</p>
</blockquote>
<h2 id="安装依赖模块"><a href="#安装依赖模块" class="headerlink" title="安装依赖模块"></a>安装依赖模块</h2><p>运行以下命令安装所需模块：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i config-lite connect-flash connect-mongo ejs express express-session marked moment mongolass objectid-to-timestamp sha1 winston express-winston --save</span><br><span class="line">npm i https://github.com:utatti/express-formidable.git --save <span class="comment"># 从 GitHub 安装 express-formidable 最新版，v1.0.0 有 bug</span></span><br></pre></td></tr></table></figure>

<p>对应模块的用处：</p>
<ol>
<li><code>express</code>: web 框架</li>
<li><code>express-session</code>: session 中间件</li>
<li><code>connect-mongo</code>: 将 session 存储于 mongodb，结合 express-session 使用</li>
<li><code>connect-flash</code>: 页面通知的中间件，基于 session 实现</li>
<li><code>ejs</code>: 模板</li>
<li><code>express-formidable</code>: 接收表单及文件上传的中间件</li>
<li><code>config-lite</code>: 读取配置文件</li>
<li><code>marked</code>: markdown 解析</li>
<li><code>moment</code>: 时间格式化</li>
<li><code>mongolass</code>: mongodb 驱动</li>
<li><code>objectid-to-timestamp</code>: 根据 ObjectId 生成时间戳</li>
<li><code>sha1</code>: sha1 加密，用于密码加密</li>
<li><code>winston</code>: 日志</li>
<li><code>express-winston</code>: express 的 winston 日志中间件</li>
</ol>
<p>后面会详细讲解这些模块的用法。</p>
<h2 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h2><p>ESLint 是一个代码规范和语法错误检查工具。使用 ESLint 可以规范我们的代码书写，可以在编写代码期间就能发现一些低级错误。</p>
<p>ESLint 需要结合编辑器或 IDE 使用，如：</p>
<ul>
<li>Sublime Text 需要装两个插件：SublimeLinter + SublimeLinter-contrib-eslint</li>
<li>VS Code 需要装一个插件：ESLint</li>
</ul>
<blockquote>
<p>小提示：Sublime Text 安装插件通过 ctrl+shift+p 调出 Package Control，输入 install 选择 Install Package 回车。输入对应插件名搜索，回车安装。<br>小提示：VS Code 安装插件需要点击左侧『扩展』页</p>
</blockquote>
<p>全局安装 eslint：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i eslint -g</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eslint --init</span><br></pre></td></tr></table></figure>

<p>初始化 eslint 配置，依次选择：</p>
<p>-&gt; Use a popular style guide<br>-&gt; Standard<br>-&gt; JSON</p>
<blockquote>
<p>注意：如果 Windows 用户使用其他命令行工具无法上下切换选项，切换回 cmd。</p>
</blockquote>
<p>eslint 会创建一个 .eslintrc.json 的配置文件，同时自动安装并添加相关的模块到 devDependencies。这里我们使用 Standard 规范，其主要特点是不加分号。</p>
<h2 id="EditorConfig"><a href="#EditorConfig" class="headerlink" title="EditorConfig"></a>EditorConfig</h2><p>EditorConfig 是一个保持缩进风格的一致的工具，当多人共同开发一个项目的时候，往往会出现每个人用不同编辑器的情况，而且有的人用 tab 缩进，有的人用 2 个空格缩进，有的人用 4 个空格缩进，EditorConfig 就是为了解决这个问题而诞生。</p>
<p>EditorConfig 需要结合编辑器或 IDE 使用，如：</p>
<ul>
<li>Sublime Text 需要装一个插件：EditorConfig</li>
<li>VS Code 需要装一个插件：EditorConfig for VS Code</li>
</ul>
<p>在 myblog 目录下新建 .editorconfig 的文件，添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># editorconfig.org</span><br><span class="line">root = true</span><br><span class="line"></span><br><span class="line">[*]</span><br><span class="line">indent_style = space</span><br><span class="line">indent_size = 2</span><br><span class="line">end_of_line = lf</span><br><span class="line">charset = utf-8</span><br><span class="line">trim_trailing_whitespace = true</span><br><span class="line">insert_final_newline = true</span><br><span class="line">tab_width = 2</span><br><span class="line"></span><br><span class="line">[*.md]</span><br><span class="line">trim_trailing_whitespace = false</span><br><span class="line"></span><br><span class="line">[Makefile]</span><br><span class="line">indent_style = tab</span><br></pre></td></tr></table></figure>

<p>这里我们使用 2 个空格缩进，tab 长度也是 2 个空格。trim_trailing_whitespace 用来删除每一行最后多余的空格，insert_final_newline 用来在代码最后插入一个空的换行。<br>不管是小项目还是大项目，将配置与代码分离是一个非常好的做法。我们通常将配置写到一个配置文件里，如 config.js 或 config.json ，并放到项目的根目录下。但实际开发时我们会有许多环境，如本地开发环境、测试环境和线上环境等，不同环境的配置不同（如：MongoDB 的地址），我们不可能每次部署时都要去修改引用 config.test.js 或者 config.production.js。config-lite 模块正是你需要的。</p>
<h2 id="config-lite"><a href="#config-lite" class="headerlink" title="config-lite"></a>config-lite</h2><p><a href="https://www.npmjs.com/package/config-lite" target="_blank" rel="noopener">config-lite</a> 是一个轻量的读取配置文件的模块。config-lite 会根据环境变量（<code>NODE_ENV</code>）的不同加载 config 目录下不同的配置文件。如果不设置 <code>NODE_ENV</code>，则读取默认的 default 配置文件，如果设置了 <code>NODE_ENV</code>，则会合并指定的配置文件和 default 配置文件作为配置，config-lite 支持 .js、.json、.node、.yml、.yaml 后缀的文件。</p>
<p>如果程序以 <code>NODE_ENV=test node app</code> 启动，则 config-lite 会依次降级查找 <code>config/test.js</code>、<code>config/test.json</code>、<code>config/test.node</code>、<code>config/test.yml</code>、<code>config/test.yaml</code> 并合并 default 配置; 如果程序以 <code>NODE_ENV=production node app</code> 启动，则 config-lite 会依次降级查找 <code>config/production.js</code>、<code>config/production.json</code>、<code>config/production.node</code>、<code>config/production.yml</code>、<code>config/production.yaml</code> 并合并 default 配置。</p>
<p>config-lite 还支持冒泡查找配置，即从传入的路径开始，从该目录不断往上一级目录查找 config 目录，直到找到或者到达根目录为止。</p>
<p>在 myblog 下新建 config 目录，在该目录下新建 default.js，添加如下代码：</p>
<p><strong>config/default.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  port: <span class="number">3000</span>,</span><br><span class="line">  session: &#123;</span><br><span class="line">    secret: <span class="string">"myblog"</span>,</span><br><span class="line">    key: <span class="string">"myblog"</span>,</span><br><span class="line">    maxAge: <span class="number">2592000000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mongodb: <span class="string">"mongodb://localhost:27017/myblog"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>配置释义：</p>
<ol>
<li><code>port</code>: 程序启动要监听的端口号</li>
<li><code>session</code>: express-session 的配置信息，后面介绍</li>
<li><code>mongodb</code>: mongodb 的地址，以 <code>mongodb://</code> 协议开头，<code>myblog</code> 为 db 名</li>
</ol>
<h2 id="功能与路由设计"><a href="#功能与路由设计" class="headerlink" title="功能与路由设计"></a>功能与路由设计</h2><p>在开发博客之前，我们首先需要明确博客要实现哪些功能。由于本教程面向初学者，所以只实现了博客最基本的功能，其余的功能（如归档、标签、分页等等）读者可自行实现。</p>
<p>功能及路由设计如下：</p>
<ol>
<li>注册<ol>
<li>注册页：<code>GET /signup</code></li>
<li>注册（包含上传头像）：<code>POST /signup</code></li>
</ol>
</li>
<li>登录<ol>
<li>登录页：<code>GET /signin</code></li>
<li>登录：<code>POST /signin</code></li>
</ol>
</li>
<li>登出：<code>GET /signout</code></li>
<li>查看文章<ol>
<li>主页：<code>GET /posts</code></li>
<li>个人主页：<code>GET /posts?author=xxx</code></li>
<li>查看一篇文章（包含留言）：<code>GET /posts/:postId</code></li>
</ol>
</li>
<li>发表文章<ol>
<li>发表文章页：<code>GET /posts/create</code></li>
<li>发表文章：<code>POST /posts/create</code></li>
</ol>
</li>
<li>修改文章<ol>
<li>修改文章页：<code>GET /posts/:postId/edit</code></li>
<li>修改文章：<code>POST /posts/:postId/edit</code></li>
</ol>
</li>
<li>删除文章：<code>GET /posts/:postId/remove</code></li>
<li>留言<ol>
<li>创建留言：<code>POST /comments</code></li>
<li>删除留言：<code>GET /comments/:commentId/remove</code></li>
</ol>
</li>
</ol>
<p>由于我们博客页面是后端渲染的，所以只通过简单的 <code>&lt;a&gt;(GET)</code> 和 <code>&lt;form&gt;(POST)</code> 与后端进行交互，如果使用 jQuery 或者其他前端框架（如 Angular、Vue、React 等等）可通过 Ajax 与后端交互，则 api 的设计应尽量遵循 Restful 风格。</p>
<h3 id="Restful"><a href="#Restful" class="headerlink" title="Restful"></a>Restful</h3><p>Restful 是一种 api 的设计风格，提出了一组 api 的设计原则和约束条件。</p>
<p>如上面删除文章的路由设计：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /posts/:postId/remove</span><br></pre></td></tr></table></figure>

<p>Restful 风格的设计：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /posts/:postId</span><br></pre></td></tr></table></figure>

<p>可以看出，Restful 风格的 api 更直观且优雅。</p>
<p>更多阅读：</p>
<ol>
<li><a href="http://www.ruanyifeng.com/blog/2011/09/restful" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2011/09/restful</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2014/05/restful_api.html</a></li>
<li><a href="http://developer.51cto.com/art/200908/141825.htm" target="_blank" rel="noopener">http://developer.51cto.com/art/200908/141825.htm</a></li>
<li><a href="http://blog.jobbole.com/41233/" target="_blank" rel="noopener">http://blog.jobbole.com/41233/</a></li>
</ol>
<h2 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h2><p>由于 HTTP 协议是无状态的协议，所以服务端需要记录用户的状态时，就需要用某种机制来识别具体的用户，这个机制就是会话（Session）。</p>
<h3 id="cookie-与-session-的区别"><a href="#cookie-与-session-的区别" class="headerlink" title="cookie 与 session 的区别"></a>cookie 与 session 的区别</h3><ol>
<li>cookie 存储在浏览器（有大小限制），session 存储在服务端（没有大小限制）</li>
<li>通常 session 的实现是基于 cookie 的，session id 存储于 cookie 中</li>
<li>session 更安全，cookie 可以直接在浏览器查看甚至编辑</li>
</ol>
<p>更多 session 的资料，参考：<a href="https://www.zhihu.com/question/19786827" target="_blank" rel="noopener">https://www.zhihu.com/question/19786827</a></p>
<p>我们通过引入 express-session 中间件实现对会话的支持：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(session(options));</span><br></pre></td></tr></table></figure>

<p>session 中间件会在 req 上添加 session 对象，即 req.session 初始值为 <code>{}</code>，当我们登录后设置 <code>req.session.user = 用户信息</code>，返回浏览器的头信息中会带上 <code>set-cookie</code> 将 session id 写到浏览器 cookie 中，那么该用户下次请求时，通过带上来的 cookie 中的 session id 我们就可以查找到该用户，并将用户信息保存到 <code>req.session.user</code>。</p>
<h2 id="页面通知"><a href="#页面通知" class="headerlink" title="页面通知"></a>页面通知</h2><p>我们还需要这样一个功能：当我们操作成功时需要显示一个成功的通知，如登录成功跳转到主页时，需要显示一个 <code>登陆成功</code> 的通知；当我们操作失败时需要显示一个失败的通知，如注册时用户名被占用了，需要显示一个 <code>用户名已占用</code> 的通知。通知只显示一次，刷新后消失，我们可以通过 connect-flash 中间件实现这个功能。</p>
<p><a href="https://www.npmjs.com/package/connect-flash" target="_blank" rel="noopener">connect-flash</a> 是基于 session 实现的，它的原理很简单：设置初始值 <code>req.session.flash={}</code>，通过 <code>req.flash(name, value)</code> 设置这个对象下的字段和值，通过 <code>req.flash(name)</code> 获取这个对象下的值，同时删除这个字段，实现了只显示一次刷新后消失的功能。</p>
<h3 id="express-session、connect-mongo-和-connect-flash-的区别与联系"><a href="#express-session、connect-mongo-和-connect-flash-的区别与联系" class="headerlink" title="express-session、connect-mongo 和 connect-flash 的区别与联系"></a>express-session、connect-mongo 和 connect-flash 的区别与联系</h3><ol>
<li><code>express-session</code>: 会话（session）支持中间件</li>
<li><code>connect-mongo</code>: 将 session 存储于 mongodb，需结合 express-session 使用，我们也可以将 session 存储于 redis，如 <a href="https://www.npmjs.com/package/connect-redis" target="_blank" rel="noopener">connect-redis</a></li>
<li><code>connect-flash</code>: 基于 session 实现的用于通知功能的中间件，需结合 express-session 使用</li>
</ol>
<h2 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h2><p>不管是论坛还是博客网站，我们没有登录的话只能浏览，登陆后才能发帖或写文章，即使登录了你也不能修改或删除其他人的文章，这就是权限控制。我们也来给博客添加权限控制，如何实现页面的权限控制呢？我们可以把用户状态的检查封装成一个中间件，在每个需要权限控制的路由加载该中间件，即可实现页面的权限控制。在 myblog 下新建 middlewares 目录，在该目录下新建 check.js，添加如下代码：</p>
<p><strong>middlewares/check.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  checkLogin: <span class="function"><span class="keyword">function</span> <span class="title">checkLogin</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.session.user) &#123;</span><br><span class="line">      req.flash(<span class="string">"error"</span>, <span class="string">"未登录"</span>);</span><br><span class="line">      <span class="keyword">return</span> res.redirect(<span class="string">"/signin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  checkNotLogin: <span class="function"><span class="keyword">function</span> <span class="title">checkNotLogin</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.session.user) &#123;</span><br><span class="line">      req.flash(<span class="string">"error"</span>, <span class="string">"已登录"</span>);</span><br><span class="line">      <span class="keyword">return</span> res.redirect(<span class="string">"back"</span>); <span class="comment">// 返回之前的页面</span></span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看出：</p>
<ol>
<li><code>checkLogin</code>: 当用户信息（<code>req.session.user</code>）不存在，即认为用户没有登录，则跳转到登录页，同时显示 <code>未登录</code> 的通知，用于需要用户登录才能操作的页面</li>
<li><code>checkNotLogin</code>: 当用户信息（<code>req.session.user</code>）存在，即认为用户已经登录，则跳转到之前的页面，同时显示 <code>已登录</code> 的通知，如已登录用户就禁止访问登录、注册页面</li>
</ol>
<p>最终我们创建以下路由文件：</p>
<p><strong>routes/index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.redirect(<span class="string">"/posts"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  app.use(<span class="string">"/signup"</span>, <span class="built_in">require</span>(<span class="string">"./signup"</span>));</span><br><span class="line">  app.use(<span class="string">"/signin"</span>, <span class="built_in">require</span>(<span class="string">"./signin"</span>));</span><br><span class="line">  app.use(<span class="string">"/signout"</span>, <span class="built_in">require</span>(<span class="string">"./signout"</span>));</span><br><span class="line">  app.use(<span class="string">"/posts"</span>, <span class="built_in">require</span>(<span class="string">"./posts"</span>));</span><br><span class="line">  app.use(<span class="string">"/comments"</span>, <span class="built_in">require</span>(<span class="string">"./comments"</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkLogin = <span class="built_in">require</span>(<span class="string">"../middlewares/check"</span>).checkLogin;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts 所有用户或者特定用户的文章页</span></span><br><span class="line"><span class="comment">//   eg: GET /posts?author=xxx</span></span><br><span class="line">router.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"主页"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /posts/create 发表一篇文章</span></span><br><span class="line">router.post(<span class="string">"/create"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"发表文章"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/create 发表文章页</span></span><br><span class="line">router.get(<span class="string">"/create"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"发表文章页"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/:postId 单独一篇的文章页</span></span><br><span class="line">router.get(<span class="string">"/:postId"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"文章详情页"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/:postId/edit 更新文章页</span></span><br><span class="line">router.get(<span class="string">"/:postId/edit"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"更新文章页"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /posts/:postId/edit 更新一篇文章</span></span><br><span class="line">router.post(<span class="string">"/:postId/edit"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"更新文章"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/:postId/remove 删除一篇文章</span></span><br><span class="line">router.get(<span class="string">"/:postId/remove"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"删除文章"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p><strong>routes/comments.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> checkLogin = <span class="built_in">require</span>(<span class="string">"../middlewares/check"</span>).checkLogin;</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /comments 创建一条留言</span></span><br><span class="line">router.post(<span class="string">"/"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"创建留言"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /comments/:commentId/remove 删除一条留言</span></span><br><span class="line">router.get(<span class="string">"/:commentId/remove"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"删除留言"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p><strong>routes/signin.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkNotLogin = <span class="built_in">require</span>(<span class="string">"../middlewares/check"</span>).checkNotLogin;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /signin 登录页</span></span><br><span class="line">router.get(<span class="string">"/"</span>, checkNotLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"登录页"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /signin 用户登录</span></span><br><span class="line">router.post(<span class="string">"/"</span>, checkNotLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"登录"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p><strong>routes/signup.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkNotLogin = <span class="built_in">require</span>(<span class="string">"../middlewares/check"</span>).checkNotLogin;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /signup 注册页</span></span><br><span class="line">router.get(<span class="string">"/"</span>, checkNotLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"注册页"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /signup 用户注册</span></span><br><span class="line">router.post(<span class="string">"/"</span>, checkNotLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"注册"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p><strong>routes/signout.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkLogin = <span class="built_in">require</span>(<span class="string">"../middlewares/check"</span>).checkLogin;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /signout 登出</span></span><br><span class="line">router.get(<span class="string">"/"</span>, checkLogin, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">"登出"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p>最后，修改 index.js 如下：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">"express-session"</span>);</span><br><span class="line"><span class="keyword">const</span> MongoStore = <span class="built_in">require</span>(<span class="string">"connect-mongo"</span>)(session);</span><br><span class="line"><span class="keyword">const</span> flash = <span class="built_in">require</span>(<span class="string">"connect-flash"</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config-lite"</span>)(__dirname);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">"./routes"</span>);</span><br><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(<span class="string">"./package"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置模板目录</span></span><br><span class="line">app.set(<span class="string">"views"</span>, path.join(__dirname, <span class="string">"views"</span>));</span><br><span class="line"><span class="comment">// 设置模板引擎为 ejs</span></span><br><span class="line">app.set(<span class="string">"view engine"</span>, <span class="string">"ejs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置静态文件目录</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">"public"</span>)));</span><br><span class="line"><span class="comment">// session 中间件</span></span><br><span class="line">app.use(</span><br><span class="line">  session(&#123;</span><br><span class="line">    name: config.session.key, <span class="comment">// 设置 cookie 中保存 session id 的字段名称</span></span><br><span class="line">    secret: config.session.secret, <span class="comment">// 通过设置 secret 来计算 hash 值并放在 cookie 中，使产生的 signedCookie 防篡改</span></span><br><span class="line">    resave: <span class="literal">true</span>, <span class="comment">// 强制更新 session</span></span><br><span class="line">    saveUninitialized: <span class="literal">false</span>, <span class="comment">// 设置为 false，强制创建一个 session，即使用户未登录</span></span><br><span class="line">    cookie: &#123;</span><br><span class="line">      maxAge: config.session.maxAge <span class="comment">// 过期时间，过期后 cookie 中的 session id 自动删除</span></span><br><span class="line">    &#125;,</span><br><span class="line">    store: <span class="keyword">new</span> MongoStore(&#123;</span><br><span class="line">      <span class="comment">// 将 session 存储到 mongodb</span></span><br><span class="line">      url: config.mongodb <span class="comment">// mongodb 地址</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// flash 中间件，用来显示通知</span></span><br><span class="line">app.use(flash());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由</span></span><br><span class="line">routes(app);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听端口，启动程序</span></span><br><span class="line">app.listen(config.port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;pkg.name&#125;</span> listening on port <span class="subst">$&#123;config.port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：中间件的加载顺序很重要。如上面设置静态文件目录的中间件应该放到 routes(app) 之前加载，这样静态文件的请求就不会落到业务逻辑的路由里；flash 中间件应该放到 session 中间件之后加载，因为 flash 是基于 session 实现的。</p>
</blockquote>
<p>运行 <code>supervisor index</code> 启动博客，访问以下地址查看效果：</p>
<ol>
<li><a href="http://localhost:3000/posts" target="_blank" rel="noopener">http://localhost:3000/posts</a></li>
<li><a href="http://localhost:3000/signout" target="_blank" rel="noopener">http://localhost:3000/signout</a></li>
<li><a href="http://localhost:3000/signup" target="_blank" rel="noopener">http://localhost:3000/signup</a><br>我们使用 jQuery + Semantic-UI 实现前端页面的设计，最终效果图如下:</li>
</ol>
<p><strong>注册页</strong></p>
<p><img src="/images/4.5.1.png" alt></p>
<p><strong>登录页</strong></p>
<p><img src="/images/4.5.2.png" alt></p>
<p><strong>未登录时的主页（或用户页）</strong></p>
<p><img src="/images/4.5.3.png" alt></p>
<p><strong>登录后的主页（或用户页）</strong></p>
<p><img src="/images/4.5.4.png" alt></p>
<p><strong>发表文章页</strong></p>
<p><img src="/images/4.5.5.png" alt></p>
<p><strong>编辑文章页</strong></p>
<p><img src="/images/4.5.6.png" alt></p>
<p><strong>未登录时的文章页</strong></p>
<p><img src="/images/4.5.7.png" alt></p>
<p><strong>登录后的文章页</strong></p>
<p><img src="/images/4.5.8.png" alt></p>
<p><strong>通知</strong></p>
<p><img src="/images/4.5.9.png" alt><br><img src="/images/4.5.10.png" alt><br><img src="/images/4.5.11.png" alt></p>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><p>前面提到过，我们可以将模板拆分成一些组件，然后使用 ejs 的 include 方法将组件组合起来进行渲染。我们将页面切分成以下组件：</p>
<p><strong>主页</strong></p>
<p><img src="/images/4.5.12.png" alt></p>
<p><strong>文章页</strong></p>
<p><img src="/images/4.5.13.png" alt></p>
<p>根据上面的组件切分图，我们创建以下样式及模板文件：</p>
<p><strong>public/css/style.css</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ---------- 全局样式 ---------- */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">1100px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">  <span class="attribute">padding-top</span>: <span class="number">40px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">3px</span> solid <span class="number">#4fc08d</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.button</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#4fc08d</span> <span class="meta">!important</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#fff</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.avatar</span> &#123;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">48px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">48px</span>;</span><br><span class="line">  <span class="attribute">float</span>: right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- nav ---------- */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav</span> &#123;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#999</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav</span> <span class="selector-tag">h1</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#4fc08d</span>;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- nav-setting ---------- */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav-setting</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: fixed;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">35px</span>;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">999</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav-setting</span> <span class="selector-class">.ui</span><span class="selector-class">.dropdown</span><span class="selector-class">.button</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">10px</span> <span class="number">0</span> <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#fff</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav-setting</span> <span class="selector-class">.icon</span><span class="selector-class">.bars</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#000</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">18px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---------- post-content ---------- */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.post-content</span> <span class="selector-tag">h3</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#4fc08d</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.post-content</span> <span class="selector-class">.tag</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">13px</span>;</span><br><span class="line">  <span class="attribute">margin-right</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#999</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.post-content</span> <span class="selector-class">.tag</span><span class="selector-class">.right</span> &#123;</span><br><span class="line">  <span class="attribute">float</span>: right;</span><br><span class="line">  <span class="attribute">margin-right</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.post-content</span> <span class="selector-class">.tag</span><span class="selector-class">.right</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#999</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>views/header.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;&lt;%= blog.title %&gt;&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;//cdn.bootcss.com/semantic-ui/2.1.8/semantic.min.css&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/style.css&quot;&gt;</span><br><span class="line">    &lt;script src=&quot;//cdn.bootcss.com/jquery/1.11.3/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;//cdn.bootcss.com/semantic-ui/2.1.8/semantic.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;%- include(&apos;components/nav&apos;) %&gt;</span><br><span class="line">  &lt;%- include(&apos;components/nav-setting&apos;) %&gt;</span><br><span class="line">  &lt;%- include(&apos;components/notification&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p><strong>views/footer.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">   $(document).ready(function () &#123;</span><br><span class="line">      // 点击按钮弹出下拉框</span><br><span class="line">      $(&apos;.ui.dropdown&apos;).dropdown();</span><br><span class="line"></span><br><span class="line">      // 鼠标悬浮在头像上，弹出气泡提示框</span><br><span class="line">      $(&apos;.post-content .avatar-link&apos;).popup(&#123;</span><br><span class="line">        inline: true,</span><br><span class="line">        position: &apos;bottom right&apos;,</span><br><span class="line">        lastResort: &apos;bottom right&apos;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：上面 <code>&lt;script&gt;&lt;/script&gt;</code> 是 semantic-ui 操控页面控件的代码，一定要放到 footer.ejs 的 <code>&lt;/body&gt;</code> 的前面，因为只有页面加载完后才能通过 JQuery 获取 DOM 元素。</p>
</blockquote>
<p>在 views 目录下新建 components 目录用来存放组件（即可以复用的模板片段），在该目录下创建以下文件：</p>
<p><strong>views/components/nav.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;nav&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;four wide column&quot;&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">      &lt;a href=&quot;/posts&quot;&gt;&lt;h1&gt;&lt;%= blog.title %&gt;&lt;/h1&gt;&lt;/a&gt;</span><br><span class="line">      &lt;p&gt;&lt;%= blog.description %&gt;&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p><strong>views/components/nav-setting.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;nav-setting&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;ui buttons&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;ui floating dropdown button&quot;&gt;</span><br><span class="line">      &lt;i class=&quot;icon bars&quot;&gt;&lt;/i&gt;</span><br><span class="line">      &lt;div class=&quot;menu&quot;&gt;</span><br><span class="line">        &lt;% if (user) &#123; %&gt;</span><br><span class="line">          &lt;a class=&quot;item&quot; href=&quot;/posts?author=&lt;%= user._id %&gt;&quot;&gt;个人主页&lt;/a&gt;</span><br><span class="line">          &lt;div class=&quot;divider&quot;&gt;&lt;/div&gt;</span><br><span class="line">          &lt;a class=&quot;item&quot; href=&quot;/posts/create&quot;&gt;发表文章&lt;/a&gt;</span><br><span class="line">          &lt;a class=&quot;item&quot; href=&quot;/signout&quot;&gt;登出&lt;/a&gt;</span><br><span class="line">        &lt;% &#125; else &#123; %&gt;</span><br><span class="line">          &lt;a class=&quot;item&quot; href=&quot;/signin&quot;&gt;登录&lt;/a&gt;</span><br><span class="line">          &lt;a class=&quot;item&quot; href=&quot;/signup&quot;&gt;注册&lt;/a&gt;</span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p><strong>views/components/notification.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;four wide column&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;% if (success) &#123; %&gt;</span><br><span class="line">    &lt;div class=&quot;ui success message&quot;&gt;</span><br><span class="line">      &lt;p&gt;&lt;%= success %&gt;&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;% if (error) &#123; %&gt;</span><br><span class="line">    &lt;div class=&quot;ui error message&quot;&gt;</span><br><span class="line">      &lt;p&gt;&lt;%= error %&gt;&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h2 id="app-locals-和-res-locals"><a href="#app-locals-和-res-locals" class="headerlink" title="app.locals 和 res.locals"></a>app.locals 和 res.locals</h2><p>上面的 ejs 模板中我们用到了 blog、user、success、error 变量，我们将 blog 变量挂载到 <code>app.locals</code> 下，将 user、success、error 挂载到 <code>res.locals</code> 下。为什么要这么做呢？<code>app.locals</code> 和 <code>res.locals</code> 是什么？它们有什么区别？</p>
<p>express 中有两个对象可用于模板的渲染：<code>app.locals</code> 和 <code>res.locals</code>。我们从 express 源码一探究竟：</p>
<p><strong>express/lib/application.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">name, options, callback</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">var</span> opts = options;</span><br><span class="line">  <span class="keyword">var</span> renderOptions = &#123;&#125;;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// merge app.locals</span></span><br><span class="line">  merge(renderOptions, <span class="keyword">this</span>.locals);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// merge options._locals</span></span><br><span class="line">  <span class="keyword">if</span> (opts._locals) &#123;</span><br><span class="line">    merge(renderOptions, opts._locals);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// merge options</span></span><br><span class="line">  merge(renderOptions, opts);</span><br><span class="line">  ...</span><br><span class="line">  tryRender(view, renderOptions, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>express/lib/response.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">res.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> app = <span class="keyword">this</span>.req.app;</span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// merge res.locals</span></span><br><span class="line">  opts._locals = self.locals;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  app.render(view, opts, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看出：在调用 <code>res.render</code> 的时候，express 合并（merge）了 3 处的结果后传入要渲染的模板，优先级：<code>res.render</code> 传入的对象&gt; <code>res.locals</code> 对象 &gt; <code>app.locals</code> 对象，所以 <code>app.locals</code> 和 <code>res.locals</code> 几乎没有区别，都用来渲染模板，使用上的区别在于：<code>app.locals</code> 上通常挂载常量信息（如博客名、描述、作者这种不会变的信息），<code>res.locals</code> 上通常挂载变量信息，即每次请求可能的值都不一样（如请求者信息，<code>res.locals.user = req.session.user</code>）。</p>
<p>修改 index.js，在 <code>routes(app)</code> 上一行添加如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置模板全局常量</span></span><br><span class="line">app.locals.blog = &#123;</span><br><span class="line">  title: pkg.name,</span><br><span class="line">  description: pkg.description</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加模板必需的三个变量</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.locals.user = req.session.user;</span><br><span class="line">  res.locals.success = req.flash(<span class="string">"success"</span>).toString();</span><br><span class="line">  res.locals.error = req.flash(<span class="string">"error"</span>).toString();</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样在调用 <code>res.render</code> 的时候就不用传入这四个变量了，express 为我们自动 merge 并传入了模板，所以我们可以在模板中直接使用这四个变量。<br>我们使用 <a href="https://github.com/mongolass/mongolass" target="_blank" rel="noopener">Mongolass</a> 这个模块操作 mongodb 进行增删改查。在 myblog 下新建 lib 目录，在该目录下新建 mongo.js，添加如下代码：</p>
<p><strong>lib/mongo.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'config-lite'</span>)(__dirname)</span><br><span class="line"><span class="keyword">const</span> Mongolass = <span class="built_in">require</span>(<span class="string">'mongolass'</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> Mongolass()</span><br><span class="line">mongolass.connect(config.mongodb)</span><br></pre></td></tr></table></figure>

<h2 id="为什么使用-Mongolass"><a href="#为什么使用-Mongolass" class="headerlink" title="为什么使用 Mongolass"></a>为什么使用 Mongolass</h2><p>早期我使用官方的 <a href="https://www.npmjs.com/package/mongodb" target="_blank" rel="noopener">mongodb</a>（也叫 node-mongodb-native）库，后来也陆续尝试使用了许多其他 mongodb 的驱动库，<a href="https://www.npmjs.com/package/mongoose" target="_blank" rel="noopener">Mongoose</a> 是比较优秀的一个，使用 Mongoose 的时间也比较长。比较这两者，各有优缺点。</p>
<h3 id="node-mongodb-native"><a href="#node-mongodb-native" class="headerlink" title="node-mongodb-native:"></a>node-mongodb-native:</h3><p><strong>优点：</strong></p>
<ol>
<li>简单。参照文档即可上手，没有 Mongoose 的 Schema 那些对新手不友好的东西。</li>
<li>强大。毕竟是官方库，包含了所有且最新的 api，其他大部分的库都是在这个库的基础上改造的，包括 Mongoose。</li>
<li>文档健全。</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>起初只支持 callback，会写出以下这种代码：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mongodb.open(<span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> callback(err)</span><br><span class="line">  &#125;</span><br><span class="line">  db.collection(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> callback(err)</span><br><span class="line">    &#125;</span><br><span class="line">    collection.find(&#123; <span class="attr">name</span>: <span class="string">'xxx'</span> &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, users</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> callback(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>或者：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MongoClient.connect(<span class="string">'mongodb://localhost:27017'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, mongodb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> callback(err)</span><br><span class="line">  &#125;</span><br><span class="line">  mongodb.db(<span class="string">'test'</span>).collection(<span class="string">'users'</span>).find(&#123; <span class="attr">name</span>: <span class="string">'xxx'</span> &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, users</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> callback(err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>现在支持 Promise 了，和 co 一起使用好很多。</p>
<ol start="2">
<li>不支持文档校验。Mongoose 通过 Schema 支持文档校验，虽说 mongodb 是 no schema 的，但在生产环境中使用 Schema 有两点好处。一是对文档做校验，防止非正常情况下写入错误的数据到数据库，二是可以简化一些代码，如类型为 ObjectId 的字段查询或更新时可通过对应的字符串操作，不用每次包装成 ObjectId 对象。</li>
</ol>
<h3 id="Mongoose"><a href="#Mongoose" class="headerlink" title="Mongoose:"></a>Mongoose:</h3><p><strong>优点：</strong></p>
<ol>
<li><p>封装了数据库的操作，给人的感觉是同步的，其实内部是异步的。如 mongoose 与 MongoDB 建立连接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/test'</span>)</span><br><span class="line"><span class="keyword">const</span> BlogModel = mongoose.model(<span class="string">'Blog'</span>, &#123; <span class="attr">title</span>: <span class="built_in">String</span>, <span class="attr">content</span>: <span class="built_in">String</span> &#125;)</span><br><span class="line">BlogModel.find()</span><br></pre></td></tr></table></figure>
</li>
<li><p>支持 Promise。这个也无需多说，Promise 是未来趋势，可结合 co 使用，也可结合 async/await 使用。</p>
</li>
<li><p>支持文档校验。如上所述。</p>
</li>
</ol>
<p><strong>缺点（个人观点）：</strong></p>
<ol>
<li>功能多，复杂。Mongoose 功能很强大，包括静态方法，实例方法，虚拟属性，hook 函数等等，混用带来的后果是逻辑复杂，代码难以维护。</li>
<li>较弱的 plugin 系统。如：<code>schema.pre(&#39;save&#39;, function(next) {})</code> 和 <code>schema.post(&#39;find&#39;, function(next) {})</code>，只支持异步 <code>next()</code>，灵活性大打折扣。</li>
<li>其他：对新手来说难以理解的 Schema、Model、Entity 之间的关系；容易混淆的 toJSON 和 toObject，以及有带有虚拟属性的情况；用和不用 exec 的情况以及直接用 then 的情况；返回的结果是 Mongoose 包装后的对象，在此对象上修改结果却无效等等。</li>
</ol>
<h3 id="Mongolass"><a href="#Mongolass" class="headerlink" title="Mongolass"></a>Mongolass</h3><p>Mongolass 保持了与 mongodb 一样的 api，又借鉴了许多 Mongoose 的优点，同时又保持了精简。</p>
<p><strong>优点：</strong></p>
<ol>
<li>支持 Promise。</li>
<li>官方一致的 api。</li>
<li>简单。参考 Mongolass 的 readme 即可上手，比 Mongoose 精简的多，本身代码也不多。</li>
<li>可选的 Schema。Mongolass 中的 Schema （基于 <a href="https://www.npmjs.com/package/another-json-schema" target="_blank" rel="noopener">another-json-schema</a>）是可选的，并且只用来做文档校验。如果定义了 schema 并关联到某个 model，则插入、更新和覆盖等操作都会校验文档是否满足 schema，同时 schema 也会尝试格式化该字段，类似于 Mongoose，如定义了一个字段为 ObjectId 类型，也可以用 ObjectId 的字符串无缝使用一样。如果没有 schema，则用法跟原生 mongodb 库一样。</li>
<li>简单却强大的插件系统。可以定义全局插件（对所有 model 生效），也可以定义某个 model 上的插件（只对该 model 生效）。Mongolass 插件的设计思路借鉴了中间件的概念（类似于 Koa），通过定义 <code>beforeXXX</code> 和 <code>afterXXX</code> （XXX为操作符首字母大写，如：<code>afterFind</code>）函数实现，函数返回 yieldable 的对象即可，所以每个插件内可以做一些其他的 IO 操作。不同的插件顺序会有不同的结果，而且每个插件的输入输出都是 plain object，而非类 Mongoose 包装后的对象，没有虚拟属性，无需调用 toJSON 或 toObject。Mongolass 中的 <code>.populate()</code>就是一个内置的插件。</li>
<li>详细的错误信息。用过 Mongoose 的人一定遇到过这样的错：<br><code>CastError: Cast to ObjectId failed for value &quot;xxx&quot; at path &quot;_id&quot;</code><br>只知道一个期望是 ObjectId 的字段传入了非期望的值，通常很难定位出错的代码，即使定位到也得不到错误现场。得益于 <a href="https://www.npmjs.com/package/another-json-schema" target="_blank" rel="noopener">another-json-schema</a>，使用 Mongolass 在查询或者更新时，某个字段不匹配它定义的 schema 时（还没落到 mongodb）会给出详细的错误信息，如下所示：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Mongolass = <span class="built_in">require</span>(<span class="string">'mongolass'</span>)</span><br><span class="line"><span class="keyword">const</span> mongolass = <span class="keyword">new</span> Mongolass(<span class="string">'mongodb://localhost:27017/test'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = mongolass.model(<span class="string">'User'</span>, &#123;</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">  age: &#123; <span class="attr">type</span>: <span class="string">'number'</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">User</span><br><span class="line">  .insertOne(&#123; <span class="attr">name</span>: <span class="string">'nswbmw'</span>, <span class="attr">age</span>: <span class="string">'wrong age'</span> &#125;)</span><br><span class="line">  .exec()</span><br><span class="line">  .then(<span class="built_in">console</span>.log)</span><br><span class="line">  .catch(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(e)</span><br><span class="line">    <span class="built_in">console</span>.error(e.stack)</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123; [Error: ($.age: "wrong age") ✖ (type: number)]</span></span><br><span class="line"><span class="comment">  validator: 'type',</span></span><br><span class="line"><span class="comment">  actual: 'wrong age',</span></span><br><span class="line"><span class="comment">  expected: &#123; type: 'number' &#125;,</span></span><br><span class="line"><span class="comment">  path: '$.age',</span></span><br><span class="line"><span class="comment">  schema: 'UserSchema',</span></span><br><span class="line"><span class="comment">  model: 'User',</span></span><br><span class="line"><span class="comment">  plugin: 'MongolassSchema',</span></span><br><span class="line"><span class="comment">  type: 'beforeInsertOne',</span></span><br><span class="line"><span class="comment">  args: [] &#125;</span></span><br><span class="line"><span class="comment">Error: ($.age: "wrong age") ✖ (type: number)</span></span><br><span class="line"><span class="comment">    at Model.insertOne (/Users/nswbmw/Desktop/mongolass-demo/node_modules/mongolass/lib/query.js:108:16)</span></span><br><span class="line"><span class="comment">    at Object.&lt;anonymous&gt; (/Users/nswbmw/Desktop/mongolass-demo/app.js:10:4)</span></span><br><span class="line"><span class="comment">    at Module._compile (module.js:409:26)</span></span><br><span class="line"><span class="comment">    at Object.Module._extensions..js (module.js:416:10)</span></span><br><span class="line"><span class="comment">    at Module.load (module.js:343:32)</span></span><br><span class="line"><span class="comment">    at Function.Module._load (module.js:300:12)</span></span><br><span class="line"><span class="comment">    at Function.Module.runMain (module.js:441:10)</span></span><br><span class="line"><span class="comment">    at startup (node.js:139:18)</span></span><br><span class="line"><span class="comment">    at node.js:974:3</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>可以看出，错误的原因是在 insertOne 一条用户数据到用户表的时候，age 期望是一个 number 类型的值，而我们传入的字符串 <code>wrong age</code>，然后从错误栈中可以快速定位到是 app.js 第 10 行代码抛出的错。</p>
<p><strong>缺点：</strong></p>
<ol>
<li><del>schema 功能较弱，缺少如 required、default 功能。</del></li>
</ol>
<h3 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h3><p><a href="https://zhuanlan.zhihu.com/p/24308524" target="_blank" rel="noopener">从零开始写一个 Node.js 的 MongoDB 驱动库</a></p>
<h2 id="用户模型设计"><a href="#用户模型设计" class="headerlink" title="用户模型设计"></a>用户模型设计</h2><p>我们只存储用户的名称、密码（加密后的）、头像、性别和个人简介这几个字段，对应修改 lib/mongo.js，添加如下代码：</p>
<p><strong>lib/mongo.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">exports.User = mongolass.model(<span class="string">'User'</span>, &#123;</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  password: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  avatar: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  gender: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">enum</span>: [<span class="string">'m'</span>, <span class="string">'f'</span>, <span class="string">'x'</span>], <span class="attr">default</span>: <span class="string">'x'</span> &#125;,</span><br><span class="line">  bio: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line">exports.User.index(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">unique</span>: <span class="literal">true</span> &#125;).exec()<span class="comment">// 根据用户名找到用户，用户名全局唯一</span></span><br></pre></td></tr></table></figure>

<p>我们定义了用户表的 schema，生成并导出了 User 这个 model，同时设置了 name 的唯一索引，保证用户名是不重复的。</p>
<blockquote>
<p>小提示：<code>required: true</code> 表示该字段是必需的，<code>default: xxx</code> 用于创建文档时设置默认值。更多关于 Mongolass 的 schema 的用法，请查阅 <a href="https://github.com/nswbmw/another-json-schema" target="_blank" rel="noopener">another-json-schema</a>。</p>
</blockquote>
<blockquote>
<p>小提示：Mongolass 中的 model 你可以认为相当于 mongodb 中的 collection，只不过添加了插件的功能。</p>
</blockquote>
<h2 id="注册页"><a href="#注册页" class="headerlink" title="注册页"></a>注册页</h2><p>首先，我们来完成注册。新建 views/signup.ejs，添加如下代码：</p>
<p><strong>views/signup.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;four wide column&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">    &lt;form class=&quot;ui form segment&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;用户名&lt;/label&gt;</span><br><span class="line">        &lt;input placeholder=&quot;用户名&quot; type=&quot;text&quot; name=&quot;name&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;密码&lt;/label&gt;</span><br><span class="line">        &lt;input placeholder=&quot;密码&quot; type=&quot;password&quot; name=&quot;password&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;重复密码&lt;/label&gt;</span><br><span class="line">        &lt;input placeholder=&quot;重复密码&quot; type=&quot;password&quot; name=&quot;repassword&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;性别&lt;/label&gt;</span><br><span class="line">        &lt;select class=&quot;ui compact selection dropdown&quot; name=&quot;gender&quot;&gt;</span><br><span class="line">          &lt;option value=&quot;m&quot;&gt;男&lt;/option&gt;</span><br><span class="line">          &lt;option value=&quot;f&quot;&gt;女&lt;/option&gt;</span><br><span class="line">          &lt;option value=&quot;x&quot;&gt;保密&lt;/option&gt;</span><br><span class="line">        &lt;/select&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;头像&lt;/label&gt;</span><br><span class="line">        &lt;input type=&quot;file&quot; name=&quot;avatar&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;个人简介&lt;/label&gt;</span><br><span class="line">        &lt;textarea name=&quot;bio&quot; rows=&quot;5&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;input type=&quot;submit&quot; class=&quot;ui button fluid&quot; value=&quot;注册&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：form 表单要添加 <code>enctype=&quot;multipart/form-data&quot;</code> 属性才能上传文件。</p>
</blockquote>
<p>修改 routes/signup.js 中获取注册页的路由如下：</p>
<p><strong>routes/signup.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /signup 注册页</span></span><br><span class="line">router.get(<span class="string">'/'</span>, checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'signup'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在访问 <code>localhost:3000/signup</code> 看看效果吧。</p>
<h2 id="注册与文件上传"><a href="#注册与文件上传" class="headerlink" title="注册与文件上传"></a>注册与文件上传</h2><p>我们使用 <a href="https://github.com/utatti/express-formidable" target="_blank" rel="noopener">express-formidable</a> 处理 form 表单（包括文件上传）。修改 index.js ，在 <code>app.use(flash())</code> 下一行添加如下代码：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理表单及文件上传的中间件</span></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'express-formidable'</span>)(&#123;</span><br><span class="line">  uploadDir: path.join(__dirname, <span class="string">'public/img'</span>), <span class="comment">// 上传文件目录</span></span><br><span class="line">  keepExtensions: <span class="literal">true</span><span class="comment">// 保留后缀</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p>新建 models/users.js，添加如下代码：</p>
<p><strong>models/users.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).User</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 注册一个用户</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> User.create(user).exec()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完善处理用户注册的路由，最终修改 routes/signup.js 如下：</p>
<p><strong>routes/signup.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> sha1 = <span class="built_in">require</span>(<span class="string">'sha1'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserModel = <span class="built_in">require</span>(<span class="string">'../models/users'</span>)</span><br><span class="line"><span class="keyword">const</span> checkNotLogin = <span class="built_in">require</span>(<span class="string">'../middlewares/check'</span>).checkNotLogin</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /signup 注册页</span></span><br><span class="line">router.get(<span class="string">'/'</span>, checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'signup'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /signup 用户注册</span></span><br><span class="line">router.post(<span class="string">'/'</span>, checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name = req.fields.name</span><br><span class="line">  <span class="keyword">const</span> gender = req.fields.gender</span><br><span class="line">  <span class="keyword">const</span> bio = req.fields.bio</span><br><span class="line">  <span class="keyword">const</span> avatar = req.files.avatar.path.split(path.sep).pop()</span><br><span class="line">  <span class="keyword">let</span> password = req.fields.password</span><br><span class="line">  <span class="keyword">const</span> repassword = req.fields.repassword</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(name.length &gt;= <span class="number">1</span> &amp;&amp; name.length &lt;= <span class="number">10</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'名字请限制在 1-10 个字符'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="string">'m'</span>, <span class="string">'f'</span>, <span class="string">'x'</span>].indexOf(gender) === <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'性别只能是 m、f 或 x'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(bio.length &gt;= <span class="number">1</span> &amp;&amp; bio.length &lt;= <span class="number">30</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'个人简介请限制在 1-30 个字符'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!req.files.avatar.name) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'缺少头像'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (password.length &lt; <span class="number">6</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'密码至少 6 个字符'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (password !== repassword) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'两次输入密码不一致'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// 注册失败，异步删除上传的头像</span></span><br><span class="line">    fs.unlink(req.files.avatar.path)</span><br><span class="line">    req.flash(<span class="string">'error'</span>, e.message)</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'/signup'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 明文密码加密</span></span><br><span class="line">  password = sha1(password)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 待写入数据库的用户信息</span></span><br><span class="line">  <span class="keyword">let</span> user = &#123;</span><br><span class="line">    name: name,</span><br><span class="line">    password: password,</span><br><span class="line">    gender: gender,</span><br><span class="line">    bio: bio,</span><br><span class="line">    avatar: avatar</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 用户信息写入数据库</span></span><br><span class="line">  UserModel.create(user)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 此 user 是插入 mongodb 后的值，包含 _id</span></span><br><span class="line">      user = result.ops[<span class="number">0</span>]</span><br><span class="line">      <span class="comment">// 删除密码这种敏感信息，将用户信息存入 session</span></span><br><span class="line">      <span class="keyword">delete</span> user.password</span><br><span class="line">      req.session.user = user</span><br><span class="line">      <span class="comment">// 写入 flash</span></span><br><span class="line">      req.flash(<span class="string">'success'</span>, <span class="string">'注册成功'</span>)</span><br><span class="line">      <span class="comment">// 跳转到首页</span></span><br><span class="line">      res.redirect(<span class="string">'/posts'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 注册失败，异步删除上传的头像</span></span><br><span class="line">      fs.unlink(req.files.avatar.path)</span><br><span class="line">      <span class="comment">// 用户名被占用则跳回注册页，而不是错误页</span></span><br><span class="line">      <span class="keyword">if</span> (e.message.match(<span class="string">'duplicate key'</span>)) &#123;</span><br><span class="line">        req.flash(<span class="string">'error'</span>, <span class="string">'用户名已被占用'</span>)</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">'/signup'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      next(e)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>

<p>我们使用 express-formidable 处理表单的上传，表单普通字段挂载到 req.fields 上，表单上传后的文件挂载到 req.files 上，文件存储在 public/img 目录下。然后校验了参数，校验通过后将用户信息插入到 MongoDB 中，成功则跳转到主页并显示『注册成功』的通知，失败（如用户名被占用）则跳转回注册页面并显示『用户名已被占用』的通知。</p>
<blockquote>
<p>注意：我们使用 sha1 加密用户的密码，sha1 并不是一种十分安全的加密方式，实际开发中可以使用更安全的 <a href="https://www.npmjs.com/package/bcrypt" target="_blank" rel="noopener">bcrypt</a> 或 <a href="https://www.npmjs.com/package/scrypt" target="_blank" rel="noopener">scrypt</a> 加密。<br>注意：注册失败时（参数校验失败或者存数据库时出错）删除已经上传到 public/img 目录下的头像。</p>
</blockquote>
<p>为了方便观察效果，我们先创建主页的模板。修改 routes/posts.js 中对应代码如下：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'posts'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>新建 views/posts.ejs，添加如下代码：</p>
<p><strong>views/posts.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line">这是主页</span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>访问 <code>localhost:3000/signup</code>，注册成功后如下所示：</p>
<p><img src="/images/4.7.1.png" alt></p>
<h2 id="登出"><a href="#登出" class="headerlink" title="登出"></a>登出</h2><p>现在我们来完成登出的功能。修改 routes/signout.js 如下：</p>
<p><strong>routes/signout.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkLogin = <span class="built_in">require</span>(<span class="string">'../middlewares/check'</span>).checkLogin</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /signout 登出</span></span><br><span class="line">router.get(<span class="string">'/'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 清空 session 中用户信息</span></span><br><span class="line">  req.session.user = <span class="literal">null</span></span><br><span class="line">  req.flash(<span class="string">'success'</span>, <span class="string">'登出成功'</span>)</span><br><span class="line">  <span class="comment">// 登出成功后跳转到主页</span></span><br><span class="line">  res.redirect(<span class="string">'/posts'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>

<p>此时刷新页面，点击右上角的 <code>登出</code>，成功后如下图所示：</p>
<p><img src="/images/4.8.1.png" alt></p>
<h2 id="登录页"><a href="#登录页" class="headerlink" title="登录页"></a>登录页</h2><p>现在我们来完成登录页。修改 routes/signin.js 相应代码如下：</p>
<p><strong>routes/signin.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'signin'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>新建 views/signin.ejs，添加如下代码：</p>
<p><strong>views/signin.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;four wide column&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">    &lt;form class=&quot;ui form segment&quot; method=&quot;post&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;用户名&lt;/label&gt;</span><br><span class="line">        &lt;input placeholder=&quot;用户名&quot; type=&quot;text&quot; name=&quot;name&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;密码&lt;/label&gt;</span><br><span class="line">        &lt;input placeholder=&quot;密码&quot; type=&quot;password&quot; name=&quot;password&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;input type=&quot;submit&quot; class=&quot;ui button fluid&quot; value=&quot;登录&quot;&gt;</span><br><span class="line">    &lt;/form&gt;  </span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>现在刷新页面，点击右边上角 <code>登录</code> 试试吧，我们已经看到了登录页，但先不要点击登录，接下来我们实现处理登录的逻辑。</p>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p>现在我们来完成登录的功能。修改 models/users.js 添加 <code>getUserByName</code> 方法用于通过用户名获取用户信息：</p>
<p><strong>models/users.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).User</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 注册一个用户</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> User.create(user).exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过用户名获取用户信息</span></span><br><span class="line">  getUserByName: <span class="function"><span class="keyword">function</span> <span class="title">getUserByName</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> User</span><br><span class="line">      .findOne(&#123; <span class="attr">name</span>: name &#125;)</span><br><span class="line">      .addCreatedAt()</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们使用了 <code>addCreatedAt</code> 自定义插件（通过 _id 生成时间戳），修改 lib/mongo.js，添加如下代码：</p>
<p><strong>lib/mongo.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>)</span><br><span class="line"><span class="keyword">const</span> objectIdToTimestamp = <span class="built_in">require</span>(<span class="string">'objectid-to-timestamp'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 id 生成创建时间 created_at</span></span><br><span class="line">mongolass.plugin(<span class="string">'addCreatedAt'</span>, &#123;</span><br><span class="line">  afterFind: <span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</span><br><span class="line">    results.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">      item.created_at = moment(objectIdToTimestamp(item._id)).format(<span class="string">'YYYY-MM-DD HH:mm'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">  &#125;,</span><br><span class="line">  afterFindOne: <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">      result.created_at = moment(objectIdToTimestamp(result._id)).format(<span class="string">'YYYY-MM-DD HH:mm'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小提示：24 位长的 ObjectId 前 4 个字节是精确到秒的时间戳，所以我们没有额外的存创建时间（如: createdAt）的字段。ObjectId 生成规则：</p>
</blockquote>
<p><img src="/images/4.8.2.png" alt></p>
<p>修改 routes/signin.js 如下：</p>
<p><strong>routes/signin.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sha1 = <span class="built_in">require</span>(<span class="string">'sha1'</span>)</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserModel = <span class="built_in">require</span>(<span class="string">'../models/users'</span>)</span><br><span class="line"><span class="keyword">const</span> checkNotLogin = <span class="built_in">require</span>(<span class="string">'../middlewares/check'</span>).checkNotLogin</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /signin 登录页</span></span><br><span class="line">router.get(<span class="string">'/'</span>, checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'signin'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /signin 用户登录</span></span><br><span class="line">router.post(<span class="string">'/'</span>, checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name = req.fields.name</span><br><span class="line">  <span class="keyword">const</span> password = req.fields.password</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!name.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写用户名'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!password.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写密码'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    req.flash(<span class="string">'error'</span>, e.message)</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  UserModel.getUserByName(name)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">user</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">        req.flash(<span class="string">'error'</span>, <span class="string">'用户不存在'</span>)</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 检查密码是否匹配</span></span><br><span class="line">      <span class="keyword">if</span> (sha1(password) !== user.password) &#123;</span><br><span class="line">        req.flash(<span class="string">'error'</span>, <span class="string">'用户名或密码错误'</span>)</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      req.flash(<span class="string">'success'</span>, <span class="string">'登录成功'</span>)</span><br><span class="line">      <span class="comment">// 用户信息写入 session</span></span><br><span class="line">      <span class="keyword">delete</span> user.password</span><br><span class="line">      req.session.user = user</span><br><span class="line">      <span class="comment">// 跳转到主页</span></span><br><span class="line">      res.redirect(<span class="string">'/posts'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>

<p>这里我们在 POST /signin 的路由处理函数中，通过传上来的 name 去数据库中找到对应用户，校验传上来的密码是否跟数据库中的一致。不一致则返回上一页（即登录页）并显示『用户名或密码错误』的通知，一致则将用户信息写入 session，跳转到主页并显示『登录成功』的通知。</p>
<p>现在刷新页面，点击右上角 <code>登录</code>，用刚才注册的账号登录，如下图所示：</p>
<p><img src="/images/4.8.3.png" alt></p>
<h2 id="文章模型设计"><a href="#文章模型设计" class="headerlink" title="文章模型设计"></a>文章模型设计</h2><p>我们只存储文章的作者 id、标题、正文和点击量这几个字段，对应修改 lib/mongo.js，添加如下代码：</p>
<p><strong>lib/mongo.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exports.Post = mongolass.model(<span class="string">'Post'</span>, &#123;</span><br><span class="line">  author: &#123; <span class="attr">type</span>: Mongolass.Types.ObjectId, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  title: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  content: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  pv: &#123; <span class="attr">type</span>: <span class="string">'number'</span>, <span class="attr">default</span>: <span class="number">0</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line">exports.Post.index(&#123; <span class="attr">author</span>: <span class="number">1</span>, <span class="attr">_id</span>: <span class="number">-1</span> &#125;).exec()<span class="comment">// 按创建时间降序查看用户的文章列表</span></span><br></pre></td></tr></table></figure>

<h2 id="发表文章"><a href="#发表文章" class="headerlink" title="发表文章"></a>发表文章</h2><p>现在我们来实现发表文章的功能。首先创建发表文章页，新建 views/create.ejs，添加如下代码：</p>
<p><strong>views/create.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;four wide column&quot;&gt;</span><br><span class="line">    &lt;a class=&quot;avatar avatar-link&quot;</span><br><span class="line">       href=&quot;/posts?author=&lt;%= user._id %&gt;&quot;</span><br><span class="line">       data-title=&quot;&lt;%= user.name %&gt; | &lt;%= (&#123;m: &apos;男&apos;, f: &apos;女&apos;, x: &apos;保密&apos;&#125;)[user.gender] %&gt;&quot;</span><br><span class="line">       data-content=&quot;&lt;%= user.bio %&gt;&quot;&gt;</span><br><span class="line">      &lt;img class=&quot;avatar&quot; src=&quot;/img/&lt;%= user.avatar %&gt;&quot;&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">    &lt;form class=&quot;ui form segment&quot; method=&quot;post&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;标题&lt;/label&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;title&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;field required&quot;&gt;</span><br><span class="line">        &lt;label&gt;内容&lt;/label&gt;</span><br><span class="line">        &lt;textarea name=&quot;content&quot; rows=&quot;15&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;input type=&quot;submit&quot; class=&quot;ui button&quot; value=&quot;发布&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>修改 routes/posts.js，将：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/create 发表文章页</span></span><br><span class="line">router.get(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'发表文章页'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/create 发表文章页</span></span><br><span class="line">router.get(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'create'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>登录成功状态，点击右上角『发表文章』试下吧。</p>
<p>发表文章页已经完成了，接下来新建 models/posts.js 用来存放与文章操作相关的代码：</p>
<p><strong>models/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Post = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).Post</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 创建一篇文章</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post.create(post).exec()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 routes/posts.js，在文件上方引入 PostModel：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PostModel = <span class="built_in">require</span>(<span class="string">'../models/posts'</span>)</span><br></pre></td></tr></table></figure>

<p>将：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST /posts/create 发表一篇文章</span></span><br><span class="line">router.post(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'发表文章'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// POST /posts/create 发表一篇文章</span></span><br><span class="line">router.post(<span class="string">'/create'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line">  <span class="keyword">const</span> title = req.fields.title</span><br><span class="line">  <span class="keyword">const</span> content = req.fields.content</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!title.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写标题'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!content.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写内容'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    req.flash(<span class="string">'error'</span>, e.message)</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> post = &#123;</span><br><span class="line">    author: author,</span><br><span class="line">    title: title,</span><br><span class="line">    content: content</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PostModel.create(post)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 此 post 是插入 mongodb 后的值，包含 _id</span></span><br><span class="line">      post = result.ops[<span class="number">0</span>]</span><br><span class="line">      req.flash(<span class="string">'success'</span>, <span class="string">'发表成功'</span>)</span><br><span class="line">      <span class="comment">// 发表成功后跳转到该文章页</span></span><br><span class="line">      res.redirect(<span class="string">`/posts/<span class="subst">$&#123;post._id&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里校验了上传的表单字段，并将文章信息插入数据库，成功后跳转到该文章页并显示『发表成功』的通知，失败后请求会进入错误处理函数。</p>
<p>现在刷新页面（登录情况下），点击右上角 <code>发表文章</code> 试试吧，发表成功后跳转到了文章页但并没有任何内容，下面我们就来实现文章页及主页。</p>
<h2 id="主页与文章页"><a href="#主页与文章页" class="headerlink" title="主页与文章页"></a>主页与文章页</h2><p>现在我们来实现主页及文章页。修改 models/posts.js 如下：</p>
<p><strong>models/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>)</span><br><span class="line"><span class="keyword">const</span> Post = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).Post</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 post 的 content 从 markdown 转换成 html</span></span><br><span class="line">Post.plugin(<span class="string">'contentToHtml'</span>, &#123;</span><br><span class="line">  afterFind: <span class="function"><span class="keyword">function</span> (<span class="params">posts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> posts.map(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      post.content = marked(post.content)</span><br><span class="line">      <span class="keyword">return</span> post</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  afterFindOne: <span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (post) &#123;</span><br><span class="line">      post.content = marked(post.content)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> post</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 创建一篇文章</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post.create(post).exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过文章 id 获取一篇文章</span></span><br><span class="line">  getPostById: <span class="function"><span class="keyword">function</span> <span class="title">getPostById</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post</span><br><span class="line">      .findOne(&#123; <span class="attr">_id</span>: postId &#125;)</span><br><span class="line">      .populate(&#123; <span class="attr">path</span>: <span class="string">'author'</span>, <span class="attr">model</span>: <span class="string">'User'</span> &#125;)</span><br><span class="line">      .addCreatedAt()</span><br><span class="line">      .contentToHtml()</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按创建时间降序获取所有用户文章或者某个特定用户的所有文章</span></span><br><span class="line">  getPosts: <span class="function"><span class="keyword">function</span> <span class="title">getPosts</span> (<span class="params">author</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> query = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (author) &#123;</span><br><span class="line">      query.author = author</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Post</span><br><span class="line">      .find(query)</span><br><span class="line">      .populate(&#123; <span class="attr">path</span>: <span class="string">'author'</span>, <span class="attr">model</span>: <span class="string">'User'</span> &#125;)</span><br><span class="line">      .sort(&#123; <span class="attr">_id</span>: <span class="number">-1</span> &#125;)</span><br><span class="line">      .addCreatedAt()</span><br><span class="line">      .contentToHtml()</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过文章 id 给 pv 加 1</span></span><br><span class="line">  incPv: <span class="function"><span class="keyword">function</span> <span class="title">incPv</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Post</span><br><span class="line">      .update(&#123; <span class="attr">_id</span>: postId &#125;, &#123; <span class="attr">$inc</span>: &#123; <span class="attr">pv</span>: <span class="number">1</span> &#125; &#125;)</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要讲解两点：</p>
<ol>
<li>我们使用了 markdown 解析文章的内容，所以在发表文章的时候可使用 markdown 语法（如插入链接、图片等等），关于 markdown 的使用请参考： <a href="http://wowubuntu.com/markdown/" target="_blank" rel="noopener">Markdown 语法说明</a>。</li>
<li>我们在 PostModel 上注册了 <code>contentToHtml</code>，而 <code>addCreatedAt</code> 是在 lib/mongo.js 中 mongolass 上注册的。也就是说 <code>contentToHtml</code> 只针对 PostModel 有效，而 <code>addCreatedAt</code> 对所有 Model 都有效。</li>
</ol>
<p>接下来完成主页的模板，修改 views/posts.ejs 如下：</p>
<p><strong>views/posts.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% posts.forEach(function (post) &#123; %&gt;</span><br><span class="line">  &lt;%- include(&apos;components/post-content&apos;, &#123; post: post &#125;) %&gt;</span><br><span class="line">&lt;% &#125;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>新建 views/components/post-content.ejs 用来存放单篇文章的模板片段：</p>
<p><strong>views/components/post-content.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;post-content&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;four wide column&quot;&gt;</span><br><span class="line">      &lt;a class=&quot;avatar avatar-link&quot;</span><br><span class="line">         href=&quot;/posts?author=&lt;%= post.author._id %&gt;&quot;</span><br><span class="line">         data-title=&quot;&lt;%= post.author.name %&gt; | &lt;%= (&#123;m: &apos;男&apos;, f: &apos;女&apos;, x: &apos;保密&apos;&#125;)[post.author.gender] %&gt;&quot;</span><br><span class="line">         data-content=&quot;&lt;%= post.author.bio %&gt;&quot;&gt;</span><br><span class="line">        &lt;img class=&quot;avatar&quot; src=&quot;/img/&lt;%= post.author.avatar %&gt;&quot;&gt;</span><br><span class="line">      &lt;/a&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;ui segment&quot;&gt;</span><br><span class="line">        &lt;h3&gt;&lt;a href=&quot;/posts/&lt;%= post._id %&gt;&quot;&gt;&lt;%= post.title %&gt;&lt;/a&gt;&lt;/h3&gt;</span><br><span class="line">        &lt;pre&gt;&lt;%- post.content %&gt;&lt;/pre&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;span class=&quot;tag&quot;&gt;&lt;%= post.created_at %&gt;&lt;/span&gt;</span><br><span class="line">          &lt;span class=&quot;tag right&quot;&gt;</span><br><span class="line">            &lt;span&gt;浏览(&lt;%= post.pv || 0 %&gt;)&lt;/span&gt;</span><br><span class="line">            &lt;span&gt;留言(&lt;%= post.commentsCount || 0 %&gt;)&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">            &lt;% if (user &amp;&amp; post.author._id &amp;&amp; user._id.toString() === post.author._id.toString()) &#123; %&gt;</span><br><span class="line">              &lt;div class=&quot;ui inline dropdown&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;text&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;i class=&quot;dropdown icon&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;div class=&quot;menu&quot;&gt;</span><br><span class="line">                  &lt;div class=&quot;item&quot;&gt;&lt;a href=&quot;/posts/&lt;%= post._id %&gt;/edit&quot;&gt;编辑&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                  &lt;div class=&quot;item&quot;&gt;&lt;a href=&quot;/posts/&lt;%= post._id %&gt;/remove&quot;&gt;删除&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;% &#125; %&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：我们用了 <code>&lt;%- post.content %&gt;</code>，而不是 <code>&lt;%= post.content %&gt;</code>，因为 post.content 是 markdown 转换后的 html 字符串。</p>
</blockquote>
<p>修改 routes/posts.js，将：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'posts'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> author = req.query.author</span><br><span class="line"></span><br><span class="line">  PostModel.getPosts(author)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">posts</span>) </span>&#123;</span><br><span class="line">      res.render(<span class="string">'posts'</span>, &#123;</span><br><span class="line">        posts: posts</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：主页与用户页通过 url 中的 author 区分。</p>
</blockquote>
<p>现在完成了主页与用户页，访问 <code>http://localhost:3000/posts</code> 试试吧，现在已经将我们之前创建的文章显示出来了，尝试点击用户的头像看看效果。</p>
<p>接下来完成文章详情页。新建 views/post.ejs，添加如下代码：</p>
<p><strong>views/post.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line">&lt;%- include(&apos;components/post-content&apos;) %&gt;</span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>打开 routes/posts.js，将：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId 单独一篇的文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'文章详情页'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId 单独一篇的文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Promise</span>.all([</span><br><span class="line">    PostModel.getPostById(postId), <span class="comment">// 获取文章信息</span></span><br><span class="line">    PostModel.incPv(postId)<span class="comment">// pv 加 1</span></span><br><span class="line">  ])</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> post = result[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'该文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      res.render(<span class="string">'post'</span>, &#123;</span><br><span class="line">        post: post</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在刷新浏览器，点击文章的标题看看浏览器地址的变化吧。</p>
<blockquote>
<p>注意：浏览器地址有变化，但页面看不出区别来（因为页面布局一样），后面我们添加留言功能后就能看出区别来了。</p>
</blockquote>
<h2 id="编辑与删除文章"><a href="#编辑与删除文章" class="headerlink" title="编辑与删除文章"></a>编辑与删除文章</h2><p>现在我们来完成编辑与删除文章的功能。修改 models/posts.js，在 module.exports 对象上添加如下 3 个方法：</p>
<p><strong>models/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过文章 id 获取一篇原生文章（编辑文章）</span></span><br><span class="line">getRawPostById: <span class="function"><span class="keyword">function</span> <span class="title">getRawPostById</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Post</span><br><span class="line">    .findOne(&#123; <span class="attr">_id</span>: postId &#125;)</span><br><span class="line">    .populate(&#123; <span class="attr">path</span>: <span class="string">'author'</span>, <span class="attr">model</span>: <span class="string">'User'</span> &#125;)</span><br><span class="line">    .exec()</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过文章 id 更新一篇文章</span></span><br><span class="line">updatePostById: <span class="function"><span class="keyword">function</span> <span class="title">updatePostById</span> (<span class="params">postId, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Post.update(&#123; <span class="attr">_id</span>: postId &#125;, &#123; <span class="attr">$set</span>: data &#125;).exec()</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过文章 id 删除一篇文章</span></span><br><span class="line">delPostById: <span class="function"><span class="keyword">function</span> <span class="title">delPostById</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Post.deleteOne(&#123; <span class="attr">_id</span>: postId &#125;).exec()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：不要忘了在适当位置添加逗号，如 incPv 的结束大括号后。</p>
</blockquote>
<blockquote>
<p>注意：我们通过新函数 <code>getRawPostById</code> 用来获取文章原生的内容（编辑页面用），而不是用 <code>getPostById</code> 返回将 markdown 转换成 html 后的内容。</p>
</blockquote>
<p>新建编辑文章页 views/edit.ejs，添加如下代码：</p>
<p><strong>views/edit.ejs</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(<span class="string">'header'</span>) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui grid"</span>&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"four wide column"</span>&gt;</span><br><span class="line">    &lt;a <span class="class"><span class="keyword">class</span></span>=<span class="string">"avatar"</span></span><br><span class="line">       href=<span class="string">"/posts?author=&lt;%= user._id %&gt;"</span></span><br><span class="line">       data-title=<span class="string">"&lt;%= user.name %&gt; | &lt;%= (&#123;m: '男', f: '女', x: '保密'&#125;)[user.gender] %&gt;"</span></span><br><span class="line">       data-content=<span class="string">"&lt;%= user.bio %&gt;"</span>&gt;</span><br><span class="line">      &lt;img <span class="class"><span class="keyword">class</span></span>=<span class="string">"avatar"</span> src=<span class="string">"/img/&lt;%= user.avatar %&gt;"</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"eight wide column"</span>&gt;</span><br><span class="line">    &lt;form <span class="class"><span class="keyword">class</span></span>=<span class="string">"ui form segment"</span> method=<span class="string">"post"</span> action=<span class="string">"/posts/&lt;%= post._id %&gt;/edit"</span>&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field required"</span>&gt;</span><br><span class="line">        &lt;label&gt;标题&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">        &lt;input type="text" name="title" value="&lt;%= post.title %&gt;"&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"field required"</span>&gt;</span><br><span class="line">        &lt;label&gt;内容&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">        &lt;textarea name="content" rows="15"&gt;&lt;%= post.content %&gt;&lt;/</span>textarea&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;input type="submit" class="ui button" value="发布"&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>form&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(<span class="string">'footer'</span>) %&gt;</span><br></pre></td></tr></table></figure>

<p>修改 routes/posts.js，将：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId/edit 更新文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'更新文章页'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /posts/:postId/edit 更新一篇文章</span></span><br><span class="line">router.post(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'更新文章'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/:postId/remove 删除一篇文章</span></span><br><span class="line">router.get(<span class="string">'/:postId/remove'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'删除文章'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId/edit 更新文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line"></span><br><span class="line">  PostModel.getRawPostById(postId)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'该文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (author.toString() !== post.author._id.toString()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'权限不足'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      res.render(<span class="string">'edit'</span>, &#123;</span><br><span class="line">        post: post</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /posts/:postId/edit 更新一篇文章</span></span><br><span class="line">router.post(<span class="string">'/:postId/edit'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line">  <span class="keyword">const</span> title = req.fields.title</span><br><span class="line">  <span class="keyword">const</span> content = req.fields.content</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!title.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写标题'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!content.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写内容'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    req.flash(<span class="string">'error'</span>, e.message)</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PostModel.getRawPostById(postId)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (post.author._id.toString() !== author.toString()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'没有权限'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      PostModel.updatePostById(postId, &#123; <span class="attr">title</span>: title, <span class="attr">content</span>: content &#125;)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          req.flash(<span class="string">'success'</span>, <span class="string">'编辑文章成功'</span>)</span><br><span class="line">          <span class="comment">// 编辑成功后跳转到上一页</span></span><br><span class="line">          res.redirect(<span class="string">`/posts/<span class="subst">$&#123;postId&#125;</span>`</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(next)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /posts/:postId/remove 删除一篇文章</span></span><br><span class="line">router.get(<span class="string">'/:postId/remove'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line"></span><br><span class="line">  PostModel.getRawPostById(postId)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (post.author._id.toString() !== author.toString()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'没有权限'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      PostModel.delPostById(postId)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          req.flash(<span class="string">'success'</span>, <span class="string">'删除文章成功'</span>)</span><br><span class="line">          <span class="comment">// 删除成功后跳转到主页</span></span><br><span class="line">          res.redirect(<span class="string">'/posts'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(next)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在刷新主页，点击文章右下角的小三角，编辑文章和删除文章试试吧。</p>
<h2 id="留言模型设计"><a href="#留言模型设计" class="headerlink" title="留言模型设计"></a>留言模型设计</h2><p>我们只需要留言的作者 id、留言内容和关联的文章 id 这几个字段，修改 lib/mongo.js，添加如下代码：</p>
<p><strong>lib/mongo.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exports.Comment = mongolass.model(<span class="string">'Comment'</span>, &#123;</span><br><span class="line">  author: &#123; <span class="attr">type</span>: Mongolass.Types.ObjectId, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  content: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  postId: &#123; <span class="attr">type</span>: Mongolass.Types.ObjectId, <span class="attr">required</span>: <span class="literal">true</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line">exports.Comment.index(&#123; <span class="attr">postId</span>: <span class="number">1</span>, <span class="attr">_id</span>: <span class="number">1</span> &#125;).exec()<span class="comment">// 通过文章 id 获取该文章下所有留言，按留言创建时间升序</span></span><br></pre></td></tr></table></figure>

<h2 id="显示留言"><a href="#显示留言" class="headerlink" title="显示留言"></a>显示留言</h2><p>在实现留言功能之前，我们先让文章页可以显示留言列表。首先创建留言的模板，新建 views/components/comments.ejs，添加如下代码：</p>
<p><strong>views/components/comments.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;ui grid&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;four wide column&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;eight wide column&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;ui segment&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;ui minimal comments&quot;&gt;</span><br><span class="line">        &lt;h3 class=&quot;ui dividing header&quot;&gt;留言&lt;/h3&gt;</span><br><span class="line"></span><br><span class="line">        &lt;% comments.forEach(function (comment) &#123; %&gt;</span><br><span class="line">          &lt;div class=&quot;comment&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;avatar&quot;&gt;</span><br><span class="line">              &lt;img src=&quot;/img/&lt;%= comment.author.avatar %&gt;&quot;&gt;</span><br><span class="line">            &lt;/span&gt;</span><br><span class="line">            &lt;div class=&quot;content&quot;&gt;</span><br><span class="line">              &lt;a class=&quot;author&quot; href=&quot;/posts?author=&lt;%= comment.author._id %&gt;&quot;&gt;&lt;%= comment.author.name %&gt;&lt;/a&gt;</span><br><span class="line">              &lt;div class=&quot;metadata&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;date&quot;&gt;&lt;%= comment.created_at %&gt;&lt;/span&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">              &lt;div class=&quot;text&quot;&gt;&lt;%- comment.content %&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">              &lt;% if (user &amp;&amp; comment.author._id &amp;&amp; user._id.toString() === comment.author._id.toString()) &#123; %&gt;</span><br><span class="line">                &lt;div class=&quot;actions&quot;&gt;</span><br><span class="line">                  &lt;a class=&quot;reply&quot; href=&quot;/comments/&lt;%= comment._id %&gt;/remove&quot;&gt;删除&lt;/a&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">              &lt;% &#125; %&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;% &#125;) %&gt;</span><br><span class="line"></span><br><span class="line">        &lt;% if (user) &#123; %&gt;</span><br><span class="line">          &lt;form class=&quot;ui reply form&quot; method=&quot;post&quot; action=&quot;/comments&quot;&gt;</span><br><span class="line">            &lt;input name=&quot;postId&quot; value=&quot;&lt;%= post._id %&gt;&quot; hidden&gt;</span><br><span class="line">            &lt;div class=&quot;field&quot;&gt;</span><br><span class="line">              &lt;textarea name=&quot;content&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;input type=&quot;submit&quot; class=&quot;ui icon button&quot; value=&quot;留言&quot; /&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：我们在提交留言表单时带上了文章 id（postId），通过 hidden 隐藏。</p>
</blockquote>
<p>在文章页引入留言的模板片段，修改 views/post.ejs 为：</p>
<p><strong>views/post.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include(&apos;header&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;components/post-content&apos;) %&gt;</span><br><span class="line">&lt;%- include(&apos;components/comments&apos;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%- include(&apos;footer&apos;) %&gt;</span><br></pre></td></tr></table></figure>

<p>新建 models/comments.js，存放留言相关的数据库操作，添加如下代码：</p>
<p><strong>models/comments.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>)</span><br><span class="line"><span class="keyword">const</span> Comment = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).Comment</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 comment 的 content 从 markdown 转换成 html</span></span><br><span class="line">Comment.plugin(<span class="string">'contentToHtml'</span>, &#123;</span><br><span class="line">  afterFind: <span class="function"><span class="keyword">function</span> (<span class="params">comments</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> comments.map(<span class="function"><span class="keyword">function</span> (<span class="params">comment</span>) </span>&#123;</span><br><span class="line">      comment.content = marked(comment.content)</span><br><span class="line">      <span class="keyword">return</span> comment</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 创建一个留言</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">comment</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Comment.create(comment).exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过留言 id 获取一个留言</span></span><br><span class="line">  getCommentById: <span class="function"><span class="keyword">function</span> <span class="title">getCommentById</span> (<span class="params">commentId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Comment.findOne(&#123; <span class="attr">_id</span>: commentId &#125;).exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过留言 id 删除一个留言</span></span><br><span class="line">  delCommentById: <span class="function"><span class="keyword">function</span> <span class="title">delCommentById</span> (<span class="params">commentId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Comment.deleteOne(&#123; <span class="attr">_id</span>: commentId &#125;).exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过文章 id 删除该文章下所有留言</span></span><br><span class="line">  delCommentsByPostId: <span class="function"><span class="keyword">function</span> <span class="title">delCommentsByPostId</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Comment.deleteMany(&#123; <span class="attr">postId</span>: postId &#125;).exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过文章 id 获取该文章下所有留言，按留言创建时间升序</span></span><br><span class="line">  getComments: <span class="function"><span class="keyword">function</span> <span class="title">getComments</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Comment</span><br><span class="line">      .find(&#123; <span class="attr">postId</span>: postId &#125;)</span><br><span class="line">      .populate(&#123; <span class="attr">path</span>: <span class="string">'author'</span>, <span class="attr">model</span>: <span class="string">'User'</span> &#125;)</span><br><span class="line">      .sort(&#123; <span class="attr">_id</span>: <span class="number">1</span> &#125;)</span><br><span class="line">      .addCreatedAt()</span><br><span class="line">      .contentToHtml()</span><br><span class="line">      .exec()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过文章 id 获取该文章下留言数</span></span><br><span class="line">  getCommentsCount: <span class="function"><span class="keyword">function</span> <span class="title">getCommentsCount</span> (<span class="params">postId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Comment.count(&#123; <span class="attr">postId</span>: postId &#125;).exec()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小提示：我们让留言也支持了 markdown。<br>注意：删除一篇文章成功后也要删除该文章下所有的评论，上面 delCommentsByPostId 就是用来做这件事的。</p>
</blockquote>
<p>修改 models/posts.js，在：</p>
<p><strong>models/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Post = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).Post</span><br></pre></td></tr></table></figure>

<p>下添加如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CommentModel = <span class="built_in">require</span>(<span class="string">'./comments'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给 post 添加留言数 commentsCount</span></span><br><span class="line">Post.plugin(<span class="string">'addCommentsCount'</span>, &#123;</span><br><span class="line">  afterFind: <span class="function"><span class="keyword">function</span> (<span class="params">posts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.all(posts.map(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> CommentModel.getCommentsCount(post._id).then(<span class="function"><span class="keyword">function</span> (<span class="params">commentsCount</span>) </span>&#123;</span><br><span class="line">        post.commentsCount = commentsCount</span><br><span class="line">        <span class="keyword">return</span> post</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;,</span><br><span class="line">  afterFindOne: <span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (post) &#123;</span><br><span class="line">      <span class="keyword">return</span> CommentModel.getCommentsCount(post._id).then(<span class="function"><span class="keyword">function</span> (<span class="params">count</span>) </span>&#123;</span><br><span class="line">        post.commentsCount = count</span><br><span class="line">        <span class="keyword">return</span> post</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> post</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在 PostModel 上注册了 <code>addCommentsCount</code> 用来给每篇文章添加留言数 <code>commentsCount</code>，在 <code>getPostById</code> 和 <code>getPosts</code> 方法里的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.addCreatedAt()</span><br></pre></td></tr></table></figure>

<p>下添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.addCommentsCount()</span><br></pre></td></tr></table></figure>

<p>这样主页和文章页的文章就可以正常显示留言数了。</p>
<p>然后将 <code>delPostById</code> 修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过用户 id 和文章 id 删除一篇文章</span></span><br><span class="line">delPostById: <span class="function"><span class="keyword">function</span> <span class="title">delPostById</span> (<span class="params">postId, author</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Post.deleteOne(&#123; <span class="attr">author</span>: author, <span class="attr">_id</span>: postId &#125;)</span><br><span class="line">    .exec()</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 文章删除后，再删除该文章下的所有留言</span></span><br><span class="line">      <span class="keyword">if</span> (res.result.ok &amp;&amp; res.result.n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CommentModel.delCommentsByPostId(postId)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小提示：虽然目前看起来使用 Mongolass 自定义插件并不能节省代码，反而使代码变多了。Mongolass 插件真正的优势在于：在项目非常庞大时，可通过自定义的插件随意组合（及顺序）实现不同的输出，如上面的 <code>getPostById</code> 需要将取出 markdown 转换成 html，则使用 <code>.contentToHtml()</code>，否则像 <code>getRawPostById</code> 则不必使用。</p>
</blockquote>
<p>修改 routes/posts.js，在：</p>
<p><strong>routes/posts.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PostModel = <span class="built_in">require</span>(<span class="string">'../models/posts'</span>)</span><br></pre></td></tr></table></figure>

<p>下引入 CommentModel:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CommentModel = <span class="built_in">require</span>(<span class="string">'../models/comments'</span>)</span><br></pre></td></tr></table></figure>

<p>在文章页传入留言列表，将：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId 单独一篇的文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET /posts/:postId 单独一篇的文章页</span></span><br><span class="line">router.get(<span class="string">'/:postId'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> postId = req.params.postId</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Promise</span>.all([</span><br><span class="line">    PostModel.getPostById(postId), <span class="comment">// 获取文章信息</span></span><br><span class="line">    CommentModel.getComments(postId), <span class="comment">// 获取该文章所有留言</span></span><br><span class="line">    PostModel.incPv(postId)<span class="comment">// pv 加 1</span></span><br><span class="line">  ])</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> post = result[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">const</span> comments = result[<span class="number">1</span>]</span><br><span class="line">      <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'该文章不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      res.render(<span class="string">'post'</span>, &#123;</span><br><span class="line">        post: post,</span><br><span class="line">        comments: comments</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在刷新文章页试试吧，此时已经显示了留言的输入框。</p>
<h2 id="发表与删除留言"><a href="#发表与删除留言" class="headerlink" title="发表与删除留言"></a>发表与删除留言</h2><p>现在我们来实现发表与删除留言的功能。将 routes/comments.js 修改如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkLogin = <span class="built_in">require</span>(<span class="string">'../middlewares/check'</span>).checkLogin</span><br><span class="line"><span class="keyword">const</span> CommentModel = <span class="built_in">require</span>(<span class="string">'../models/comments'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /comments 创建一条留言</span></span><br><span class="line">router.post(<span class="string">'/'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line">  <span class="keyword">const</span> postId = req.fields.postId</span><br><span class="line">  <span class="keyword">const</span> content = req.fields.content</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!content.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'请填写留言内容'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    req.flash(<span class="string">'error'</span>, e.message)</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> comment = &#123;</span><br><span class="line">    author: author,</span><br><span class="line">    postId: postId,</span><br><span class="line">    content: content</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  CommentModel.create(comment)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      req.flash(<span class="string">'success'</span>, <span class="string">'留言成功'</span>)</span><br><span class="line">      <span class="comment">// 留言成功后跳转到上一页</span></span><br><span class="line">      res.redirect(<span class="string">'back'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(next)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /comments/:commentId/remove 删除一条留言</span></span><br><span class="line">router.get(<span class="string">'/:commentId/remove'</span>, checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> commentId = req.params.commentId</span><br><span class="line">  <span class="keyword">const</span> author = req.session.user._id</span><br><span class="line"></span><br><span class="line">  CommentModel.getCommentById(commentId)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> (<span class="params">comment</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!comment) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'留言不存在'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (comment.author.toString() !== author.toString()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'没有权限删除留言'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      CommentModel.delCommentById(commentId)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          req.flash(<span class="string">'success'</span>, <span class="string">'删除留言成功'</span>)</span><br><span class="line">          <span class="comment">// 删除成功后跳转到上一页</span></span><br><span class="line">          res.redirect(<span class="string">'back'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(next)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>

<p>至此，我们完成了创建留言和删除留言的逻辑。刷新页面，尝试留言试试吧。留言成功后，将鼠标悬浮在留言上可以显示出 <code>删除</code> 的按钮，点击可以删除留言。</p>
<p>现在访问一个不存在的地址，如：<code>http://localhost:3000/haha</code> 页面会显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot GET /haha</span><br></pre></td></tr></table></figure>

<h2 id="404-页面"><a href="#404-页面" class="headerlink" title="404 页面"></a>404 页面</h2><p>我们来自定义 404 页面。修改 routes/index.js，在：</p>
<p><strong>routes/index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="string">'/comments'</span>, <span class="built_in">require</span>(<span class="string">'./comments'</span>))</span><br></pre></td></tr></table></figure>

<p>下添加如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 404 page</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!res.headersSent) &#123;</span><br><span class="line">    res.status(<span class="number">404</span>).render(<span class="string">'404'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>新建 views/404.ejs，添加如下代码：</p>
<p><strong>views/404.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;&lt;%= blog.title %&gt;&lt;/title&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;http://www.qq.com/404/search_children.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们只为了演示 express 中处理 404 的情况，用了腾讯公益的 404 页面，刷新一下页面看下效果吧。</p>
<p>前面讲到 express 有一个内置的错误处理逻辑，如果程序出错，会直接将错误栈返回并显示到页面上。如访问：<code>localhost:3000/posts/xxx/edit</code> 没有权限编辑的文章页，将会直接在页面中显示错误栈，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span>: 权限不足</span><br><span class="line">    at /Users/nswbmw/Desktop/myblog/routes/posts.js:<span class="number">95</span>:<span class="number">15</span></span><br><span class="line">    at &lt;anonymous&gt;</span><br><span class="line">    at process._tickCallback (internal/process/next_tick.js:<span class="number">188</span>:<span class="number">7</span>)</span><br></pre></td></tr></table></figure>

<p>现在我们修改代码，实现复用页面通知。修改 index.js，在 <code>app.listen</code> 上面添加如下代码：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err)</span><br><span class="line">  req.flash(<span class="string">'error'</span>, err.message)</span><br><span class="line">  res.redirect(<span class="string">'/posts'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里我们实现了将错误信息用页面通知展示的功能，刷新页面将会跳转到主页并显示『权限不足』的红色通知。</p>
<p>现在我们来实现日志功能，日志分为正常请求的日志和错误请求的日志，我们希望实现这两种日志都打印到终端并写入文件。</p>
<h2 id="winston-和-express-winston"><a href="#winston-和-express-winston" class="headerlink" title="winston 和 express-winston"></a>winston 和 express-winston</h2><p>我们使用 <a href="https://www.npmjs.com/package/winston" target="_blank" rel="noopener">winston</a> 和 <a href="https://www.npmjs.com/package/express-winston" target="_blank" rel="noopener">express-winston</a> 记录日志。</p>
<p>新建 logs 目录存放日志文件，修改 index.js，在：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(<span class="string">'./package'</span>)</span><br></pre></td></tr></table></figure>

<p>下引入所需模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> winston = <span class="built_in">require</span>(<span class="string">'winston'</span>)</span><br><span class="line"><span class="keyword">const</span> expressWinston = <span class="built_in">require</span>(<span class="string">'express-winston'</span>)</span><br></pre></td></tr></table></figure>

<p>将：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 路由</span><br><span class="line">routes(app)</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正常请求的日志</span></span><br><span class="line">app.use(expressWinston.logger(&#123;</span><br><span class="line">  transports: [</span><br><span class="line">    <span class="keyword">new</span> (winston.transports.Console)(&#123;</span><br><span class="line">      json: <span class="literal">true</span>,</span><br><span class="line">      colorize: <span class="literal">true</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> winston.transports.File(&#123;</span><br><span class="line">      filename: <span class="string">'logs/success.log'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// 路由</span></span><br><span class="line">routes(app)</span><br><span class="line"><span class="comment">// 错误请求的日志</span></span><br><span class="line">app.use(expressWinston.errorLogger(&#123;</span><br><span class="line">  transports: [</span><br><span class="line">    <span class="keyword">new</span> winston.transports.Console(&#123;</span><br><span class="line">      json: <span class="literal">true</span>,</span><br><span class="line">      colorize: <span class="literal">true</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> winston.transports.File(&#123;</span><br><span class="line">      filename: <span class="string">'logs/error.log'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p>刷新页面看一下终端输出及 logs 下的文件。<br>可以看出：winston 将正常请求的日志打印到终端并写入了 <code>logs/success.log</code>，将错误请求的日志打印到终端并写入了 <code>logs/error.log</code>。</p>
<blockquote>
<p>注意：记录正常请求日志的中间件要放到 <code>routes(app)</code> 之前，记录错误请求日志的中间件要放到 <code>routes(app)</code> 之后。</p>
</blockquote>
<h2 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h2><p>如果我们想把项目托管到 git 服务器上（如: <a href="https://github.com" target="_blank" rel="noopener">GitHub</a>），而不想把线上配置、本地调试的 logs 以及 node_modules 添加到 git 的版本控制中，这个时候就需要 .gitignore 文件了，git 会读取 .gitignore 并忽略这些文件。在 myblog 下新建 .gitignore 文件，添加如下配置：</p>
<p><strong>.gitignore</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config/*</span><br><span class="line">!config/default.*</span><br><span class="line">npm-debug.log</span><br><span class="line">node_modules</span><br><span class="line">coverage</span><br></pre></td></tr></table></figure>

<p>需要注意的是，通过设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config/*</span><br><span class="line">!config/default.*</span><br></pre></td></tr></table></figure>

<p>这样只有 config/default.js 会加入 git 的版本控制，而 config 目录下的其他配置文件则会被忽略，因为把线上配置加入到 git 是一个不安全的行为，通常你需要本地或者线上环境手动创建 config/production.js，然后添加一些线上的配置（如：mongodb 配置）即可覆盖相应的 default 配置。</p>
<blockquote>
<p>注意：后面讲到部署到 Heroku 时，因为无法登录到 Heroku 主机，所以可以把以下两行删掉，将 config/production.js 也加入 git 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; config/*</span><br><span class="line">&gt; !config/default.*</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>然后在 public/img 目录下创建 .gitignore：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Ignore everything in this directory</span><br><span class="line">*</span><br><span class="line"># Except this file</span><br><span class="line">!.gitignore</span><br></pre></td></tr></table></figure>

<p>这样 git 会忽略 public/img 目录下所有上传的头像，而不忽略 public/img 目录。同理，在 logs 目录下创建 .gitignore 忽略日志文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Ignore everything in this directory</span><br><span class="line">*</span><br><span class="line"># Except this file</span><br><span class="line">!.gitignore</span><br></pre></td></tr></table></figure>

<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="mocha-和-supertest"><a href="#mocha-和-supertest" class="headerlink" title="mocha 和 supertest"></a>mocha 和 supertest</h2><p><a href="https://www.npmjs.com/package/mocha" target="_blank" rel="noopener">mocha</a> 和 <a href="https://www.npmjs.com/package/supertest" target="_blank" rel="noopener">supertest</a> 是常用的测试组合，通常用来测试 restful 的 api 接口，这里我们也可以用来测试我们的博客应用。<br>在 myblog 下新建 test 文件夹存放测试文件，以注册为例讲解 mocha 和 supertest 的用法。首先安装所需模块：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mocha supertest --save-dev</span><br></pre></td></tr></table></figure>

<p>修改 package.json，将：</p>
<p><strong>package.json</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "mocha test"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指定执行 test 目录的测试。修改 index.js，将：</p>
<p><strong>index.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听端口，启动程序</span></span><br><span class="line">app.listen(config.port, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;pkg.name&#125;</span> listening on port <span class="subst">$&#123;config.port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>修改为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.parent) &#123;</span><br><span class="line">  <span class="comment">// 被 require，则导出 app</span></span><br><span class="line">  <span class="built_in">module</span>.exports = app</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 监听端口，启动程序</span></span><br><span class="line">  app.listen(config.port, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;pkg.name&#125;</span> listening on port <span class="subst">$&#123;config.port&#125;</span>`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样做可以实现：直接启动 index.js 则会监听端口启动程序，如果 index.js 被 require 了，则导出 app，通常用于测试。</p>
<p>找一张图片用于测试上传头像，放到 test 目录下，如 avatar.png。新建 test/signup.js，添加如下测试代码：</p>
<p><strong>test/signup.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>)</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'supertest'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'../index'</span>)</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">'../lib/mongo'</span>).User</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> testName1 = <span class="string">'testName1'</span></span><br><span class="line"><span class="keyword">const</span> testName2 = <span class="string">'nswbmw'</span></span><br><span class="line">describe(<span class="string">'signup'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'POST /signup'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> agent = request.agent(app)<span class="comment">// persist cookie when redirect</span></span><br><span class="line">    beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 创建一个用户</span></span><br><span class="line">      User.create(&#123;</span><br><span class="line">        name: testName1,</span><br><span class="line">        password: <span class="string">'123456'</span>,</span><br><span class="line">        avatar: <span class="string">''</span>,</span><br><span class="line">        gender: <span class="string">'x'</span>,</span><br><span class="line">        bio: <span class="string">''</span></span><br><span class="line">      &#125;)</span><br><span class="line">        .exec()</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          done()</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(done)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    afterEach(<span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 删除测试用户</span></span><br><span class="line">      User.deleteMany(&#123; <span class="attr">name</span>: &#123; <span class="attr">$in</span>: [testName1, testName2] &#125; &#125;)</span><br><span class="line">        .exec()</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          done()</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(done)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    after(<span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">      process.exit()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户名错误的情况</span></span><br><span class="line">    it(<span class="string">'wrong name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">      agent</span><br><span class="line">        .post(<span class="string">'/signup'</span>)</span><br><span class="line">        .type(<span class="string">'form'</span>)</span><br><span class="line">        .field(&#123; <span class="attr">name</span>: <span class="string">''</span> &#125;)</span><br><span class="line">        .attach(<span class="string">'avatar'</span>, path.join(__dirname, <span class="string">'avatar.png'</span>))</span><br><span class="line">        .redirects()</span><br><span class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err)</span><br><span class="line">          assert(res.text.match(<span class="regexp">/名字请限制在 1-10 个字符/</span>))</span><br><span class="line">          done()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 性别错误的情况</span></span><br><span class="line">    it(<span class="string">'wrong gender'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">      agent</span><br><span class="line">        .post(<span class="string">'/signup'</span>)</span><br><span class="line">        .type(<span class="string">'form'</span>)</span><br><span class="line">        .field(&#123; <span class="attr">name</span>: testName2, <span class="attr">gender</span>: <span class="string">'a'</span> &#125;)</span><br><span class="line">        .attach(<span class="string">'avatar'</span>, path.join(__dirname, <span class="string">'avatar.png'</span>))</span><br><span class="line">        .redirects()</span><br><span class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err)</span><br><span class="line">          assert(res.text.match(<span class="regexp">/性别只能是 m、f 或 x/</span>))</span><br><span class="line">          done()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 其余的参数测试自行补充</span></span><br><span class="line">    <span class="comment">// 用户名被占用的情况</span></span><br><span class="line">    it(<span class="string">'duplicate name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">      agent</span><br><span class="line">        .post(<span class="string">'/signup'</span>)</span><br><span class="line">        .type(<span class="string">'form'</span>)</span><br><span class="line">        .field(&#123; <span class="attr">name</span>: testName1, <span class="attr">gender</span>: <span class="string">'m'</span>, <span class="attr">bio</span>: <span class="string">'noder'</span>, <span class="attr">password</span>: <span class="string">'123456'</span>, <span class="attr">repassword</span>: <span class="string">'123456'</span> &#125;)</span><br><span class="line">        .attach(<span class="string">'avatar'</span>, path.join(__dirname, <span class="string">'avatar.png'</span>))</span><br><span class="line">        .redirects()</span><br><span class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err)</span><br><span class="line">          assert(res.text.match(<span class="regexp">/用户名已被占用/</span>))</span><br><span class="line">          done()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册成功的情况</span></span><br><span class="line">    it(<span class="string">'success'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">      agent</span><br><span class="line">        .post(<span class="string">'/signup'</span>)</span><br><span class="line">        .type(<span class="string">'form'</span>)</span><br><span class="line">        .field(&#123; <span class="attr">name</span>: testName2, <span class="attr">gender</span>: <span class="string">'m'</span>, <span class="attr">bio</span>: <span class="string">'noder'</span>, <span class="attr">password</span>: <span class="string">'123456'</span>, <span class="attr">repassword</span>: <span class="string">'123456'</span> &#125;)</span><br><span class="line">        .attach(<span class="string">'avatar'</span>, path.join(__dirname, <span class="string">'avatar.png'</span>))</span><br><span class="line">        .redirects()</span><br><span class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err)</span><br><span class="line">          assert(res.text.match(<span class="regexp">/注册成功/</span>))</span><br><span class="line">          done()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>此时编辑器会报语法错误（如：describe 未定义等等），修改 .eslintrc.json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extends"</span>: <span class="string">"standard"</span>,</span><br><span class="line">  <span class="attr">"globals"</span>: &#123;</span><br><span class="line">    <span class="attr">"describe"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"beforeEach"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"afterEach"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"after"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"it"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，eslint 会忽略 globals 中变量未定义的警告。运行 <code>npm test</code> 看看效果吧，其余的测试请读者自行完成。</p>
<h2 id="测试覆盖率"><a href="#测试覆盖率" class="headerlink" title="测试覆盖率"></a>测试覆盖率</h2><p>我们写测试肯定想覆盖所有的情况（包括各种出错的情况及正确时的情况），但光靠想需要写哪些测试是不行的，总也会有疏漏，最简单的办法就是可以直观的看出测试是否覆盖了所有的代码，这就是测试覆盖率，即被测试覆盖到的代码行数占总代码行数的比例。</p>
<blockquote>
<p>注意：即使测试覆盖率达到 100% 也不能说明你的测试覆盖了所有的情况，只能说明基本覆盖了所有的情况。</p>
</blockquote>
<p><a href="https://www.npmjs.com/package/istanbul" target="_blank" rel="noopener">istanbul</a> 是一个常用的生成测试覆盖率的库，它会将测试的结果报告生成 html 页面，并放到项目根目录的 coverage 目录下。首先安装 istanbul:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i istanbul --save-dev</span><br></pre></td></tr></table></figure>

<p>配置 istanbul 很简单，将 package.json 中：</p>
<p><strong>package.json</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "mocha test"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "istanbul cover _mocha"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：Windows 下需要改成 <code>istanbul cover node_modules/mocha/bin/_mocha</code>。</p>
<p>即可将 istanbul 和 mocha 结合使用，运行 <code>npm test</code> 终端会打印：</p>
<p><img src="/images/4.14.1.png" alt></p>
<p>打开 myblog/coverage/Icov-report/index.html，如下所示：</p>
<p><img src="/images/4.14.2.png" alt></p>
<p>可以点进去查看某个代码文件具体的覆盖率，如下所示：</p>
<p><img src="/images/4.14.3.png" alt></p>
<p>红色的行表示测试没有覆盖到，因为我们只写了 name 和 gender 的测试。</p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="申请-MLab"><a href="#申请-MLab" class="headerlink" title="申请 MLab"></a>申请 MLab</h2><p><a href="https://mlab.com" target="_blank" rel="noopener">MLab</a> (前身是 MongoLab) 是一个 mongodb 云数据库提供商，我们可以选择 500MB 空间的免费套餐用来测试。注册成功后，点击右上角的 <code>Create New</code> 创建一个数据库（如: myblog），成功后点击进入到该数据库详情页，注意页面中有一行黄色的警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A database user is required to connect to this database. To create one now, visit the &apos;Users&apos; tab and click the &apos;Add database user&apos; button.</span><br></pre></td></tr></table></figure>

<p>每个数据库至少需要一个 user，所以我们点击 Users 下的 <code>Add database user</code> 创建一个用户。</p>
<blockquote>
<p>注意：不要选中 <code>Make read-only</code>，因为我们有写数据库的操作。</p>
</blockquote>
<p>最后分配给我们的类似下面的 mongodb url：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;@ds139327.mlab.com:39327/myblog</span><br></pre></td></tr></table></figure>

<p>如我创建的用户名和密码都为 myblog 的用户，新建 config/production.js，添加如下代码：</p>
<p><strong>config/production.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mongodb: <span class="string">'mongodb://myblog:myblog@ds139327.mlab.com:39327/myblog'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>停止程序，然后以 production 配置启动程序:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i cross-env --save-dev <span class="comment"># 本地安装 cross-env</span></span><br><span class="line">npm i cross-env -g <span class="comment"># 全局安装 cross-env</span></span><br><span class="line">cross-env NODE_ENV=production supervisor index</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：cross-env 用来兼容 Windows 系统和 Linux/Mac 系统设置环境变量的差异。</p>
</blockquote>
<h2 id="pm2"><a href="#pm2" class="headerlink" title="pm2"></a>pm2</h2><p>当我们的博客要部署到线上服务器时，不能单纯的靠 <code>node index</code> 或者 <code>supervisor index</code> 来启动了，因为我们断掉 SSH 连接后服务就终止了，这时我们就需要像 <a href="https://www.npmjs.com/package/pm2" target="_blank" rel="noopener">pm2</a> 或者 <a href="https://www.npmjs.com/package/forever" target="_blank" rel="noopener">forever</a> 这样的进程管理工具了。pm2 是 Node.js 下的生产环境进程管理工具，就是我们常说的进程守护工具，可以用来在生产环境中进行自动重启、日志记录、错误预警等等。以 pm2 为例，全局安装 pm2：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i pm2 -g</span><br></pre></td></tr></table></figure>

<p>修改 package.json，添加 start 的命令：</p>
<p><strong>package.json</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "istanbul cover _mocha",</span><br><span class="line">  "start": "cross-env NODE_ENV=production pm2 start index.js --name 'myblog'"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后运行 <code>npm start</code> 通过 pm2 启动程序，如下图所示 ：</p>
<p><img src="/images/4.15.1.png" alt></p>
<p>pm2 常用命令:</p>
<ol>
<li><code>pm2 start/stop</code>: 启动/停止程序</li>
<li><code>pm2 reload/restart [id|name]</code>: 重启程序</li>
<li><code>pm2 logs [id|name]</code>: 查看日志</li>
<li><code>pm2 l/list</code>: 列出程序列表</li>
</ol>
<p>更多命令请使用 <code>pm2 -h</code> 查看。</p>
<h2 id="部署到-Heroku"><a href="#部署到-Heroku" class="headerlink" title="部署到 Heroku"></a>部署到 Heroku</h2><p><a href="https://www.heroku.com" target="_blank" rel="noopener">Heroku</a> 是一个支持多种编程语言的云服务平台，Heroku 也提供免费的基础套餐供开发者测试使用。现在，我们将论坛部署到 Heroku。</p>
<blockquote>
<p>注意：新版 heroku 会有填写信用卡的步骤，如果没有信用卡请跳过本节。</p>
</blockquote>
<p>首先，需要到 <a href="https://toolbelt.heroku.com/" target="_blank" rel="noopener">https://toolbelt.heroku.com/</a> 下载安装 Heroku 的命令行工具包 toolbelt。然后登录（如果没有账号，请注册）到 Heroku 的 Dashboard，点击右上角 New -&gt; Create New App 创建一个应用。创建成功后运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroku login</span><br></pre></td></tr></table></figure>

<p>填写正确的 email 和 password 验证通过后，本地会产生一个 SSH public key。在部署到 Heroku 之前，我们需要对代码进行简单的修改。如下：</p>
<p>1.删掉 .gitignore 中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config/*</span><br><span class="line">!config/default.*</span><br></pre></td></tr></table></figure>

<p>因为我们无法登录到 Heroku 主机创建 production 配置文件，所以这里将 production 配置也上传到 Heroku。</p>
<p>2.打开 index.js，将 <code>app.listen</code> 修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> port = process.env.PORT || config.port</span><br><span class="line">app.listen(port, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;pkg.name&#125;</span> listening on port <span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>因为 Heroku 会动态分配端口（通过环境变量 PORT 指定），所以不能用配置文件里写死的端口。</p>
<p>3.修改 package.json，在 scripts 添加：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"heroku": "NODE_ENV=production node index"</span><br></pre></td></tr></table></figure>

<p>在根目录下新建 Procfile 文件，添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web: npm run heroku</span><br></pre></td></tr></table></figure>

<p>Procfile 文件告诉 Heroku 该使用什么命令启动一个 web 服务。更多信息见：<a href="https://devcenter.heroku.com/articles/getting-started-with-nodejs" target="_blank" rel="noopener">https://devcenter.heroku.com/articles/getting-started-with-nodejs</a>。</p>
<p>然后输入以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">heroku git:remote -a 你的应用名称</span><br><span class="line">git add .</span><br><span class="line">git commit -am <span class="string">"init"</span></span><br><span class="line">git push heroku master</span><br></pre></td></tr></table></figure>

<p>稍后，我们的论坛就部署成功了。使用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroku open</span><br></pre></td></tr></table></figure>

<p>打开应用主页。如果出现 “Application error”，使用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroku logs</span><br></pre></td></tr></table></figure>

<p>查看日志，调试完后 commit 并 push 到 heroku重新部署。</p>
<h2 id="部署到-UCloud"><a href="#部署到-UCloud" class="headerlink" title="部署到 UCloud"></a>部署到 UCloud</h2><h3 id="创建主机"><a href="#创建主机" class="headerlink" title="创建主机"></a>创建主机</h3><ol>
<li>注册 UCloud</li>
<li>点击左侧的 <code>云主机</code>，然后点击 <code>创建主机</code>，统统选择最低配置</li>
<li>右侧付费方式选择 <code>按时</code>（每小时），点击 <code>立即购买</code></li>
<li>在支付确认页面，点击 <code>确认支付</code></li>
</ol>
<p>购买成功后回到主机管理列表，如下所示：</p>
<p><img src="/images/4.15.2.png" alt></p>
<blockquote>
<p>注意：下面所有的 ip 都替换为你自己的外网 ip。</p>
</blockquote>
<h3 id="环境搭建与部署"><a href="#环境搭建与部署" class="headerlink" title="环境搭建与部署"></a>环境搭建与部署</h3><p>修改 config/production.js，将 port 修改为 80 端口：</p>
<p><strong>config/production.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  port: <span class="number">80</span>,</span><br><span class="line">  mongodb: <span class="string">'mongodb://myblog:myblog@ds139327.mlab.com:39327/myblog'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录主机，用刚才设置的密码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@106.75.47.229</span><br></pre></td></tr></table></figure>

<p>因为是 CentOS 系统，所以我选择使用 yum 安装，而不是下载源码编译安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install git <span class="comment">#安装git</span></span><br><span class="line">yum install nodejs <span class="comment">#安装 Node.js</span></span><br><span class="line">yum install npm <span class="comment">#安装 npm</span></span><br><span class="line"></span><br><span class="line">npm i npm -g <span class="comment">#升级 npm</span></span><br><span class="line">npm i pm2 -g <span class="comment">#安装 pm2</span></span><br><span class="line">npm i n -g <span class="comment">#安装 n</span></span><br><span class="line">n v8.9.1 <span class="comment">#安装 v8.9.1 版本的 Node.js</span></span><br><span class="line">n use 8.9.1 <span class="comment">#使用 v8.9.1 版本的 Node.js</span></span><br><span class="line">node -v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果 <code>node -v</code> 显示的不是 8.9.1，则断开 ssh，重新登录主机再试试。</p>
</blockquote>
<p>此时应该在 <code>/root</code> 目录下，运行以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/nswbmw/N-blog.git myblog <span class="comment">#或在本机 myblog 目录下运行 rsync -av --exclude="node_modules" ./ root@106.75.47.229:/root/myblog</span></span><br><span class="line"><span class="built_in">cd</span> myblog</span><br><span class="line">npm i</span><br><span class="line">npm start</span><br><span class="line">pm2 logs</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果不想用 git 的形式将代码拉到云主机上，可以用 rsync 将本地的代码同步到你的 UCloud 主机上，如上所示。</p>
</blockquote>
<p>最后，访问你的公网 ip 地址试试吧，如下所示：</p>
<p><img src="/images/4.15.3.png" alt></p>
<blockquote>
<p>小提示：因为我们选择的按时付费套餐，测试完成后，可在主机管理页面选择关闭主机，节约费用。</p>
</blockquote>
<h2 id="部署到阿里云"><a href="#部署到阿里云" class="headerlink" title="部署到阿里云"></a>部署到阿里云</h2><h3 id="创建主机-1"><a href="#创建主机-1" class="headerlink" title="创建主机"></a>创建主机</h3><ol>
<li>注册/登录</li>
<li>充值 100（因为我们选择『按量付费』，阿里云要求最低账户余额 &gt;= 100）</li>
<li>进入『云服务器 ECS』</li>
<li>点击『创建实例』</li>
</ol>
<p>进入创建实例页面，按下图选择配置：</p>
<p><img src="/images/4.15.4.png" alt></p>
<p>需要注意几点：</p>
<ol>
<li>计费方式：按量付费</li>
<li>公网 ip 地址：分配</li>
<li>安全组：选中开启 80 端口</li>
<li>镜像：Ubuntu 16.04 64位</li>
</ol>
<p>点击『开通进入下一页』，选中：</p>
<p><img src="/images/4.15.5.png" alt></p>
<blockquote>
<p>注意：这里我们只是演示，所以自动释放时间只设置了几个小时</p>
</blockquote>
<p>点击『去开通』创建成功，然后点击提示中的『管理控制台』进入 ECS 管理页，刚才创建的机器需要等待几分钟才会初始化成功。成功后如下所示：</p>
<p><img src="/images/4.15.6.png" alt></p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>复制创建的机器的公网 ip 地址，运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@39.106.134.66</span><br></pre></td></tr></table></figure>

<p>输入刚才设置的密码登录远程主机。</p>
<h4 id="安装-Node-js-1"><a href="#安装-Node-js-1" class="headerlink" title="安装 Node.js"></a>安装 Node.js</h4><p>我们下载编译好的 Node.js 压缩包，解压然后使用软连接。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://nodejs.org/dist/v8.9.1/node-v8.9.1-linux-x64.tar.xz</span><br><span class="line">tar -xvf node-v8.9.1-linux-x64.tar.xz</span><br><span class="line">mv node-v8.9.1-linux-x64 nodejs</span><br><span class="line">ln -s ~/nodejs/bin/* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<h4 id="安装-MongoDB"><a href="#安装-MongoDB" class="headerlink" title="安装 MongoDB"></a>安装 MongoDB</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-3.4.10.tgz</span><br><span class="line">tar -xvf mongodb-linux-x86_64-ubuntu1604-3.4.10.tgz</span><br><span class="line">mv mongodb-linux-x86_64-ubuntu1604-3.4.10 mongodb</span><br><span class="line">ln -s ~/mongodb/bin/* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">mongod --version</span><br><span class="line">mongo --version</span><br><span class="line">mkdir mongodb/data</span><br><span class="line">mongod --dbpath=mongodb/data &amp;</span><br></pre></td></tr></table></figure>

<h4 id="安装-Git"><a href="#安装-Git" class="headerlink" title="安装 Git"></a>安装 Git</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install git</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/nswbmw/N-blog.git <span class="comment">#或者你的 GitHub blog 地址</span></span><br><span class="line"><span class="built_in">cd</span> N-blog</span><br><span class="line">npm i</span><br><span class="line">vim config/default.js <span class="comment">#修改端口 3000-&gt;80</span></span><br><span class="line">node index</span><br></pre></td></tr></table></figure>

<p>此时，浏览器中访问你的机器的公网 ip 试试吧。</p>
<h4 id="使用-PM2-启动"><a href="#使用-PM2-启动" class="headerlink" title="使用 PM2 启动"></a>使用 PM2 启动</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i pm2 -g</span><br><span class="line">ln -s ~/nodejs/bin/* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">pm2 start index.js --name=<span class="string">"myblog"</span></span><br></pre></td></tr></table></figure>

<p>这里我们使用 pm2 启动博客，所以关掉终端后博客仍然在运行。</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/08/14/LoopBack3-0官方文档中文增强版/" rel="next" title="LoopBack3.0官方文档中文增强版">
                  <i class="fa fa-chevron-left"></i> LoopBack3.0官方文档中文增强版
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/09/19/hexo常用命令/" rel="prev" title="hexo常用命令">
                  hexo常用命令 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/laoxue.png"
      alt="老学">
  <p class="site-author-name" itemprop="name">老学</p>
  <div class="site-description motion-element" itemprop="description">好记性不如烂笔头</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Node-js"><span class="nav-number">1.</span> <span class="nav-text">Node.js</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-Node-js"><span class="nav-number">1.1.</span> <span class="nav-text">安装 Node.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-和-Mac-安装："><span class="nav-number">1.1.1.</span> <span class="nav-text">Windows 和 Mac 安装：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#第一步："><span class="nav-number">1.1.1.1.</span> <span class="nav-text">第一步：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第二步："><span class="nav-number">1.1.1.2.</span> <span class="nav-text">第二步：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第三步："><span class="nav-number">1.1.1.3.</span> <span class="nav-text">第三步：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-安装："><span class="nav-number">1.1.2.</span> <span class="nav-text">Linux 安装：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#n-和-nvm"><span class="nav-number">1.2.</span> <span class="nav-text">n 和 nvm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nrm"><span class="nav-number">1.3.</span> <span class="nav-text">nrm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装与启动-MongoDB"><span class="nav-number">1.4.</span> <span class="nav-text">安装与启动 MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Robomongo-和-Mongochef"><span class="nav-number">1.4.1.</span> <span class="nav-text">Robomongo 和 Mongochef</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Robomongo"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">Robomongo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoChef"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">MongoChef</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#require"><span class="nav-number">1.5.</span> <span class="nav-text">require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#循环引用"><span class="nav-number">1.6.</span> <span class="nav-text">循环引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#导出"><span class="nav-number">1.7.</span> <span class="nav-text">导出</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Promise"><span class="nav-number">2.</span> <span class="nav-text">Promise</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#深入-Promise"><span class="nav-number">2.1.</span> <span class="nav-text">深入 Promise</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#semver"><span class="nav-number">2.2.</span> <span class="nav-text">semver</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#npm"><span class="nav-number">3.</span> <span class="nav-text">npm</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#npm-init"><span class="nav-number">3.1.</span> <span class="nav-text">npm init</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#npm-install"><span class="nav-number">3.2.</span> <span class="nav-text">npm install</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#npm-scripts"><span class="nav-number">3.3.</span> <span class="nav-text">npm scripts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#npm-shrinkwrap"><span class="nav-number">3.4.</span> <span class="nav-text">npm shrinkwrap</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#express"><span class="nav-number">4.</span> <span class="nav-text">express</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#supervisor"><span class="nav-number">4.1.</span> <span class="nav-text">supervisor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#express-Router"><span class="nav-number">4.2.</span> <span class="nav-text">express.Router</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ejs"><span class="nav-number">4.3.</span> <span class="nav-text">ejs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#includes"><span class="nav-number">4.4.</span> <span class="nav-text">includes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#中间件与-next"><span class="nav-number">4.5.</span> <span class="nav-text">中间件与 next</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#错误处理"><span class="nav-number">4.6.</span> <span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目录结构"><span class="nav-number">4.7.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装依赖模块"><span class="nav-number">4.8.</span> <span class="nav-text">安装依赖模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ESLint"><span class="nav-number">4.9.</span> <span class="nav-text">ESLint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EditorConfig"><span class="nav-number">4.10.</span> <span class="nav-text">EditorConfig</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#config-lite"><span class="nav-number">4.11.</span> <span class="nav-text">config-lite</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#功能与路由设计"><span class="nav-number">4.12.</span> <span class="nav-text">功能与路由设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Restful"><span class="nav-number">4.12.1.</span> <span class="nav-text">Restful</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#会话"><span class="nav-number">4.13.</span> <span class="nav-text">会话</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cookie-与-session-的区别"><span class="nav-number">4.13.1.</span> <span class="nav-text">cookie 与 session 的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面通知"><span class="nav-number">4.14.</span> <span class="nav-text">页面通知</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#express-session、connect-mongo-和-connect-flash-的区别与联系"><span class="nav-number">4.14.1.</span> <span class="nav-text">express-session、connect-mongo 和 connect-flash 的区别与联系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#权限控制"><span class="nav-number">4.15.</span> <span class="nav-text">权限控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组件"><span class="nav-number">4.16.</span> <span class="nav-text">组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#app-locals-和-res-locals"><span class="nav-number">4.17.</span> <span class="nav-text">app.locals 和 res.locals</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么使用-Mongolass"><span class="nav-number">4.18.</span> <span class="nav-text">为什么使用 Mongolass</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#node-mongodb-native"><span class="nav-number">4.18.1.</span> <span class="nav-text">node-mongodb-native:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mongoose"><span class="nav-number">4.18.2.</span> <span class="nav-text">Mongoose:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mongolass"><span class="nav-number">4.18.3.</span> <span class="nav-text">Mongolass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展阅读"><span class="nav-number">4.18.4.</span> <span class="nav-text">扩展阅读</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户模型设计"><span class="nav-number">4.19.</span> <span class="nav-text">用户模型设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册页"><span class="nav-number">4.20.</span> <span class="nav-text">注册页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册与文件上传"><span class="nav-number">4.21.</span> <span class="nav-text">注册与文件上传</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#登出"><span class="nav-number">4.22.</span> <span class="nav-text">登出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#登录页"><span class="nav-number">4.23.</span> <span class="nav-text">登录页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#登录"><span class="nav-number">4.24.</span> <span class="nav-text">登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文章模型设计"><span class="nav-number">4.25.</span> <span class="nav-text">文章模型设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发表文章"><span class="nav-number">4.26.</span> <span class="nav-text">发表文章</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主页与文章页"><span class="nav-number">4.27.</span> <span class="nav-text">主页与文章页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编辑与删除文章"><span class="nav-number">4.28.</span> <span class="nav-text">编辑与删除文章</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#留言模型设计"><span class="nav-number">4.29.</span> <span class="nav-text">留言模型设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示留言"><span class="nav-number">4.30.</span> <span class="nav-text">显示留言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发表与删除留言"><span class="nav-number">4.31.</span> <span class="nav-text">发表与删除留言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#404-页面"><span class="nav-number">4.32.</span> <span class="nav-text">404 页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#winston-和-express-winston"><span class="nav-number">4.33.</span> <span class="nav-text">winston 和 express-winston</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gitignore"><span class="nav-number">4.34.</span> <span class="nav-text">.gitignore</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#测试"><span class="nav-number">5.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mocha-和-supertest"><span class="nav-number">5.1.</span> <span class="nav-text">mocha 和 supertest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试覆盖率"><span class="nav-number">5.2.</span> <span class="nav-text">测试覆盖率</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署"><span class="nav-number">6.</span> <span class="nav-text">部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#申请-MLab"><span class="nav-number">6.1.</span> <span class="nav-text">申请 MLab</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pm2"><span class="nav-number">6.2.</span> <span class="nav-text">pm2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署到-Heroku"><span class="nav-number">6.3.</span> <span class="nav-text">部署到 Heroku</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署到-UCloud"><span class="nav-number">6.4.</span> <span class="nav-text">部署到 UCloud</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建主机"><span class="nav-number">6.4.1.</span> <span class="nav-text">创建主机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境搭建与部署"><span class="nav-number">6.4.2.</span> <span class="nav-text">环境搭建与部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署到阿里云"><span class="nav-number">6.5.</span> <span class="nav-text">部署到阿里云</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建主机-1"><span class="nav-number">6.5.1.</span> <span class="nav-text">创建主机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境搭建"><span class="nav-number">6.5.2.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-Node-js-1"><span class="nav-number">6.5.2.1.</span> <span class="nav-text">安装 Node.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-MongoDB"><span class="nav-number">6.5.2.2.</span> <span class="nav-text">安装 MongoDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-Git"><span class="nav-number">6.5.2.3.</span> <span class="nav-text">安装 Git</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-PM2-启动"><span class="nav-number">6.5.2.4.</span> <span class="nav-text">使用 PM2 启动</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">老学</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.3.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

<script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>


  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



<script src="/js/next-boot.js?v=7.3.0"></script>




  




























  

  

  


  
  <script src="/js/scrollspy.js?v=7.3.0"></script>
<script src="/js/post-details.js?v=7.3.0"></script>


</body>
</html>
